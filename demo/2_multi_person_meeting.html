<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2. å¤šäººä¼šè®® - ä¿¡ä»¤æœåŠ¡å™¨æ¨¡å¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .login-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .login-form {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        .login-form input {
            flex: 1;
            min-width: 150px;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        .login-form input:focus {
            outline: none;
            border-color: #11998e;
        }
        .login-form button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .btn-join {
            background: #11998e;
            color: white;
        }
        .btn-join:hover:not(:disabled) {
            background: #0d7a71;
            transform: translateY(-2px);
        }
        .btn-leave {
            background: #dc3545;
            color: white;
        }
        .btn-leave:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .room-info {
            background: #d1e7dd;
            padding: 12px 20px;
            margin: 10px 20px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            font-size: 14px;
            font-weight: 600;
            color: #155724;
            display: none;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .room-info.active {
            display: flex;
        }
        .room-id-display {
            background: white;
            padding: 4px 10px;
            border-radius: 4px;
            color: #155724;
            font-family: monospace;
        }

        .status {
            padding: 10px 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
            text-align: center;
        }
        .status.active { display: block; }
        .status.success { background: #d1e7dd; border-left-color: #28a745; }
        .status.error { background: #f8d7da; border-left-color: #dc3545; }
        .status.info { background: #e3f2fd; border-left-color: #2196f3; }

        .info-box {
            background: #e3f2fd;
            padding: 15px 20px;
            margin: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
            line-height: 1.6;
        }
        .info-box strong { color: #1976d2; }

        .connection-mode {
            background: #fff3cd;
            padding: 12px 20px;
            margin: 10px 20px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            font-size: 13px;
            font-weight: 600;
            color: #856404;
            text-align: center;
        }

        .controls {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }
        .controls.active {
            display: block;
        }
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover:not(:disabled) { background: #e0a800; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover:not(:disabled) { background: #388e3c; }

        .video-grid {
            display: grid;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            min-height: 300px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 2;
        }
        .participant-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(17, 153, 142, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        .connection-status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.9);
        }
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.9);
        }

        .participants-panel {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        .participants-panel.active {
            display: block;
        }
        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .participant-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #2196f3;
        }
        .participant-tag.you {
            background: #d1e7dd;
            color: #155724;
            border-color: #28a745;
        }
        .participant-tag.remote {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .signal-section {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        .signal-section.active {
            display: block;
        }
        .signal-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .signal-box textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        .signal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover:not(:disabled) { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover:not(:disabled) { background: #218838; }

        .server-mode {
            background: #e3f2fd;
            padding: 15px 20px;
            margin: 10px 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
        }
        .server-mode input {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
        }

        .stats {
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
            display: none;
        }
        .stats.active {
            display: flex;
        }
        .stat-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-weight: 700;
            color: #007bff;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ 2. å¤šäººä¼šè®® - ä¿¡ä»¤æœåŠ¡å™¨æ¨¡å¼</h1>
            <p>é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å®ç°å¤šäººP2Pè¿æ¥</p>
        </div>

        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ æœ¬é¡µé¢ä½¿ç”¨ä¿¡ä»¤æœåŠ¡å™¨è¿›è¡Œè‡ªåŠ¨è¿æ¥<br>
            â€¢ æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„æœåŠ¡å™¨åœ°å€å’Œæˆ¿é—´å·<br>
            â€¢ æ­¥éª¤1ï¼šè¾“å…¥æœåŠ¡å™¨åœ°å€ï¼ˆé»˜è®¤æœ¬åœ°ws://localhost:8080ï¼‰<br>
            â€¢ æ­¥éª¤2ï¼šè¾“å…¥ç”¨æˆ·åå’Œæˆ¿é—´å·<br>
            â€¢ æ­¥éª¤3ï¼šç‚¹å‡»"åŠ å…¥æˆ¿é—´"ï¼Œç³»ç»Ÿè‡ªåŠ¨è¿æ¥å…¶ä»–ç”¨æˆ·<br>
            â€¢ æ³¨æ„ï¼šéœ€è¦å…ˆå¯åŠ¨ä¿¡ä»¤æœåŠ¡å™¨
        </div>

        <div class="connection-mode">
            å½“å‰æ¨¡å¼ï¼šä¿¡ä»¤æœåŠ¡å™¨è‡ªåŠ¨è¿æ¥ï¼ˆæ”¯æŒå¤šäººï¼‰
        </div>

        <div class="server-mode">
            <strong>ä¿¡ä»¤æœåŠ¡å™¨é…ç½®ï¼š</strong><br>
            <small>å¦‚æœæ²¡æœ‰ä¿¡ä»¤æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼</small><br>
            <input type="text" id="serverUrlInput" placeholder="ws://localhost:8080" value="ws://localhost:8080">
        </div>

        <div class="login-section">
            <div class="login-form">
                <input type="text" id="usernameInput" placeholder="æ‚¨çš„ç”¨æˆ·å" maxlength="20">
                <input type="text" id="roomInput" placeholder="ä¼šè®®å· (å¦‚: 1001)" maxlength="20">
                <button class="btn-join" id="joinBtn" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
                <button class="btn-leave" id="leaveBtn" onclick="leaveRoom()" disabled>ç¦»å¼€æˆ¿é—´</button>
            </div>
        </div>

        <div class="room-info" id="roomInfo">
            <span>æˆ¿é—´: <span class="room-id-display" id="currentRoomId">-</span></span>
            <span>çŠ¶æ€: <span id="roomStatus">æœªè¿æ¥</span></span>
            <span>ç”¨æˆ·: <span id="userCount">0</span></span>
        </div>

        <div id="status" class="status"></div>

        <div class="controls" id="controls">
            <div class="control-group">
                <button class="btn btn-secondary" id="toggleAudioBtn" onclick="toggleAudio()">ğŸ”‡ é™éŸ³</button>
                <button class="btn btn-secondary" id="toggleVideoBtn" onclick="toggleVideo()">ğŸ“· å…³é—­æ‘„åƒå¤´</button>
                <button class="btn btn-warning" id="addManualBtn" onclick="showManualMode()">ğŸ”§ æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼</button>
            </div>
        </div>

        <div class="video-grid" id="videoGrid">
            <div class="video-container">
                <div class="video-placeholder">
                    <div class="emoji">ğŸšª</div>
                    <div>ç­‰å¾…åŠ å…¥æˆ¿é—´...</div>
                </div>
            </div>
        </div>

        <div class="participants-panel" id="participantsPanel">
            <strong>æˆ¿é—´å‚ä¸è€…:</strong>
            <div class="participants-list" id="participantsList"></div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-item">è¿æ¥æ•°: <span class="stat-value" id="connCount">0</span></div>
            <div class="stat-item">å¸¦å®½: <span class="stat-value" id="bandwidth">-</span></div>
            <div class="stat-item">å»¶è¿Ÿ: <span class="stat-value" id="latency">-</span></div>
        </div>

        <div class="signal-section" id="signalSection">
            <div class="signal-box">
                <strong>æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼ï¼ˆå¤‡ç”¨ï¼‰ï¼š</strong><br>
                <small>å¦‚æœä¿¡ä»¤æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æ­¤æ¨¡å¼</small><br>
                <div style="margin-top: 10px;">
                    <button class="btn btn-primary btn-small" onclick="switchToManualMode()">åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let localStream = null;
        let username = null;
        let roomId = null;
        let audioEnabled = true;
        let videoEnabled = true;

        // å­˜å‚¨æ‰€æœ‰PeerConnection
        const peerConnections = {}; // userId -> RTCPeerConnection
        const remoteStreams = {}; // userId -> MediaStream

        // ä¿¡ä»¤æœåŠ¡å™¨ç›¸å…³
        let ws = null;
        let isManualMode = false;

        // WebRTC é…ç½®
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status active ${type}`;
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            if (protocol === 'file:') {
                showStatus('âŒ è¯·ä½¿ç”¨ http://localhost:8000 è®¿é—®', 'error');
                return false;
            }
            if (protocol === 'http:' && !isLocalhost) {
                showStatus('âŒ è¯·ä½¿ç”¨ localhost è®¿é—®', 'error');
                return false;
            }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebRTC', 'error');
                return false;
            }
            return true;
        }

        // åŠ å…¥æˆ¿é—´
        async function joinRoom() {
            if (!checkEnvironment()) return;

            const usernameInput = document.getElementById('usernameInput');
            const roomInput = document.getElementById('roomInput');
            const serverUrlInput = document.getElementById('serverUrlInput');

            username = usernameInput.value.trim();
            roomId = roomInput.value.trim();
            const serverUrl = serverUrlInput.value.trim();

            if (!username || !roomId) {
                showStatus('âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œæˆ¿é—´å·', 'error');
                return;
            }

            try {
                showStatus('â³ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£...', 'info');

                // è¯·æ±‚æœ¬åœ°åª’ä½“
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });

                // æ¸²æŸ“æœ¬åœ°è§†é¢‘
                renderLocalVideo();

                // å°è¯•è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
                if (!isManualMode && serverUrl) {
                    try {
                        await connectSignalingServer(serverUrl);
                        showStatus('âœ… å·²è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ï¼Œç­‰å¾…å…¶ä»–ç”¨æˆ·...', 'success');
                    } catch (error) {
                        console.warn('ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                        showStatus('âš ï¸ ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œå¯åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼', 'error');
                        document.getElementById('signalSection').classList.add('active');
                    }
                }

                // æ›´æ–°UI
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = false;
                document.getElementById('controls').classList.add('active');
                document.getElementById('roomInfo').classList.add('active');
                document.getElementById('participantsPanel').classList.add('active');
                document.getElementById('stats').classList.add('active');

                document.getElementById('currentRoomId').textContent = roomId;
                document.getElementById('roomStatus').textContent = 'å·²åŠ å…¥';
                updateParticipantCount();

                // æ·»åŠ è‡ªå·±åˆ°å‚ä¸è€…åˆ—è¡¨
                addParticipantToList(username, 'you');

            } catch (error) {
                console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                showStatus(`âŒ åŠ å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸²æŸ“æœ¬åœ°è§†é¢‘
        function renderLocalVideo() {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '';

            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = 'local-container';
            container.innerHTML = `
                <div class="video-label">ğŸ‘¤ ${username} (è‡ªå·±)</div>
                <div class="participant-count">1</div>
                <div class="connection-status connected">å·²è¿æ¥</div>
                <video id="localVideo" autoplay muted playsinline></video>
            `;
            grid.appendChild(container);

            const video = document.getElementById('localVideo');
            video.srcObject = localStream;
        }

        // æ¸²æŸ“è¿œç¨‹è§†é¢‘
        function renderRemoteVideo(userId, stream) {
            const grid = document.getElementById('videoGrid');

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existing = document.getElementById(`remote-${userId}`);
            if (existing) {
                const video = existing.querySelector('video');
                video.srcObject = stream;
                return;
            }

            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `remote-${userId}`;
            container.innerHTML = `
                <div class="video-label">ğŸ‘¥ ${userId}</div>
                <div class="connection-status connected">å·²è¿æ¥</div>
                <video autoplay playsinline></video>
            `;
            grid.appendChild(container);

            const video = container.querySelector('video');
            video.srcObject = stream;

            // æ›´æ–°è®¡æ•°
            updateParticipantCount();
        }

        // è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
        function connectSignalingServer(serverUrl) {
            return new Promise((resolve, reject) => {
                try {
                    ws = new WebSocket(serverUrl);

                    ws.onopen = () => {
                        console.log('ä¿¡ä»¤æœåŠ¡å™¨å·²è¿æ¥');
                        // å‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
                        ws.send(JSON.stringify({
                            type: 'join',
                            username: username,
                            roomId: roomId
                        }));
                    };

                    ws.onmessage = async (event) => {
                        const message = JSON.parse(event.data);
                        console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

                        switch (message.type) {
                            case 'peerJoined':
                                // æœ‰æ–°ç”¨æˆ·åŠ å…¥ï¼Œåˆ›å»ºOffer
                                if (message.username !== username) {
                                    showStatus(`ğŸ‘¤ ${message.username} åŠ å…¥æˆ¿é—´ï¼Œæ­£åœ¨å»ºç«‹è¿æ¥...`, 'info');
                                    await createOfferToUser(message.username);
                                }
                                break;

                            case 'peerLeft':
                                // ç”¨æˆ·ç¦»å¼€
                                removePeer(message.username);
                                showStatus(`âš ï¸ ${message.username} å·²ç¦»å¼€`, 'info');
                                break;

                            case 'offer':
                                // æ”¶åˆ°Offerï¼Œåˆ›å»ºAnswer
                                if (message.to === username) {
                                    showStatus(`ğŸ“¨ æ”¶åˆ° ${message.from} çš„è¿æ¥è¯·æ±‚`, 'info');
                                    await handleOffer(message.from, message.sdp);
                                }
                                break;

                            case 'answer':
                                // æ”¶åˆ°Answer
                                if (message.to === username) {
                                    showStatus(`âœ… æ”¶åˆ° ${message.from} çš„åº”ç­”`, 'success');
                                    await handleAnswer(message.from, message.sdp);
                                }
                                break;

                            case 'iceCandidate':
                                // æ”¶åˆ°ICEå€™é€‰
                                if (message.to === username) {
                                    await handleIceCandidate(message.from, message.candidate);
                                }
                                break;

                            case 'peers':
                                // å½“å‰æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ - é‡è¦ï¼šä¸ºæ¯ä¸ªå·²å­˜åœ¨çš„ç”¨æˆ·åˆ›å»ºOffer
                                message.peers.forEach(async (peer) => {
                                    if (peer !== username) {
                                        addParticipantToList(peer, 'remote');
                                        showStatus(`ğŸ‘¤ å‘ç°ç”¨æˆ· ${peer}ï¼Œæ­£åœ¨è¿æ¥...`, 'info');
                                        // ä¸ºå·²å­˜åœ¨çš„ç”¨æˆ·åˆ›å»ºOffer
                                        await createOfferToUser(peer);
                                    }
                                });
                                updateParticipantCount();
                                break;

                            case 'error':
                                showStatus(`âŒ ${message.message}`, 'error');
                                break;
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        reject(error);
                    };

                    ws.onclose = () => {
                        console.log('ä¿¡ä»¤æœåŠ¡å™¨å·²æ–­å¼€');
                        showStatus('âš ï¸ ä¿¡ä»¤æœåŠ¡å™¨æ–­å¼€', 'error');
                    };

                    resolve();

                } catch (error) {
                    reject(error);
                }
            });
        }

        // åˆ›å»ºOfferç»™æŒ‡å®šç”¨æˆ·
        async function createOfferToUser(targetUsername) {
            if (!localStream) {
                console.error('æœ¬åœ°æµæœªå‡†å¤‡');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿æ¥ï¼Œé¿å…é‡å¤åˆ›å»º
            if (peerConnections[targetUsername]) {
                console.log(`ä¸ ${targetUsername} çš„è¿æ¥å·²å­˜åœ¨`);
                return;
            }

            console.log(`æ­£åœ¨ä¸º ${targetUsername} åˆ›å»ºOffer...`);

            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[targetUsername] = pc;

            // æ·»åŠ æœ¬åœ°æµ
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // ç›‘å¬è¿œç¨‹æµ
            pc.ontrack = (event) => {
                console.log(`æ”¶åˆ° ${targetUsername} çš„æµ`, event.streams);
                const stream = event.streams[0];
                if (!remoteStreams[targetUsername]) {
                    remoteStreams[targetUsername] = stream;
                    renderRemoteVideo(targetUsername, stream);
                }
            };

            // ç›‘å¬ICEå€™é€‰
            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'iceCandidate',
                        from: username,
                        to: targetUsername,
                        candidate: event.candidate
                    }));
                }
            };

            // ç›‘å¬è¿æ¥çŠ¶æ€
            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log(`${targetUsername} è¿æ¥çŠ¶æ€: ${state}`);
                updateStats();

                if (state === 'connected') {
                    addParticipantToList(targetUsername, 'remote');
                    showStatus(`âœ… ä¸ ${targetUsername} è¿æ¥æˆåŠŸ`, 'success');
                } else if (state === 'disconnected' || state === 'failed') {
                    showStatus(`âš ï¸ ä¸ ${targetUsername} è¿æ¥æ–­å¼€`, 'error');
                }
            };

            // åˆ›å»ºOffer
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // å‘é€Offer
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'offer',
                    from: username,
                    to: targetUsername,
                    sdp: pc.localDescription.sdp
                }));
                console.log(`å·²å‘é€Offerç»™ ${targetUsername}`);
            }
        }

        // å¤„ç†Offer
        async function handleOffer(fromUsername, remoteSdp) {
            if (!localStream) {
                console.error('æœ¬åœ°æµæœªå‡†å¤‡');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿æ¥ï¼ˆå¹¶å‘Offerå¤„ç†ï¼‰
            if (peerConnections[fromUsername]) {
                console.log(`ä¸ ${fromUsername} çš„è¿æ¥å·²å­˜åœ¨ï¼Œå¿½ç•¥é‡å¤Offer`);
                return;
            }

            console.log(`æ­£åœ¨å¤„ç† ${fromUsername} çš„Offer...`);

            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[fromUsername] = pc;

            // æ·»åŠ æœ¬åœ°æµ
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // ç›‘å¬è¿œç¨‹æµ
            pc.ontrack = (event) => {
                console.log(`æ”¶åˆ° ${fromUsername} çš„æµ`, event.streams);
                const stream = event.streams[0];
                if (!remoteStreams[fromUsername]) {
                    remoteStreams[fromUsername] = stream;
                    renderRemoteVideo(fromUsername, stream);
                }
            };

            // ç›‘å¬ICEå€™é€‰
            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'iceCandidate',
                        from: username,
                        to: fromUsername,
                        candidate: event.candidate
                    }));
                }
            };

            // ç›‘å¬è¿æ¥çŠ¶æ€
            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log(`${fromUsername} è¿æ¥çŠ¶æ€: ${state}`);
                updateStats();

                if (state === 'connected') {
                    addParticipantToList(fromUsername, 'remote');
                    showStatus(`âœ… ä¸ ${fromUsername} è¿æ¥æˆåŠŸ`, 'success');
                } else if (state === 'disconnected' || state === 'failed') {
                    showStatus(`âš ï¸ ä¸ ${fromUsername} è¿æ¥æ–­å¼€`, 'error');
                }
            };

            // è®¾ç½®è¿œç¨‹Description
            await pc.setRemoteDescription(new RTCSessionDescription({
                type: 'offer',
                sdp: remoteSdp
            }));

            // åˆ›å»ºAnswer
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            // å‘é€Answer
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'answer',
                    from: username,
                    to: fromUsername,
                    sdp: pc.localDescription.sdp
                }));
                console.log(`å·²å‘é€Answerç»™ ${fromUsername}`);
            }
        }

        // å¤„ç†Answer
        async function handleAnswer(fromUsername, remoteSdp) {
            const pc = peerConnections[fromUsername];
            if (!pc) {
                console.error(`æœªæ‰¾åˆ°PeerConnection: ${fromUsername}`);
                return;
            }

            await pc.setRemoteDescription(new RTCSessionDescription({
                type: 'answer',
                sdp: remoteSdp
            }));

            console.log(`ä¸ ${fromUsername} çš„è¿æ¥å»ºç«‹å®Œæˆ`);
        }

        // å¤„ç†ICEå€™é€‰
        async function handleIceCandidate(fromUsername, candidate) {
            const pc = peerConnections[fromUsername];
            if (!pc) {
                console.error(`æœªæ‰¾åˆ°PeerConnection: ${fromUsername}`);
                return;
            }

            try {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (error) {
                console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', error);
            }
        }

        // ç§»é™¤Peer
        function removePeer(username) {
            const pc = peerConnections[username];
            if (pc) {
                pc.close();
                delete peerConnections[username];
            }

            const stream = remoteStreams[username];
            if (stream) {
                delete remoteStreams[username];
            }

            // ä»UIç§»é™¤
            const container = document.getElementById(`remote-${username}`);
            if (container) {
                container.remove();
            }

            // ä»å‚ä¸è€…åˆ—è¡¨ç§»é™¤
            removeParticipantFromList(username);

            updateParticipantCount();
            updateStats();

            showStatus(`âš ï¸ ${username} å·²ç¦»å¼€`, 'info');
        }

        // æ·»åŠ åˆ°å‚ä¸è€…åˆ—è¡¨
        function addParticipantToList(name, type = 'remote') {
            const list = document.getElementById('participantsList');

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existing = list.querySelector(`[data-name="${name}"]`);
            if (existing) return;

            const tag = document.createElement('div');
            tag.className = `participant-tag ${type}`;
            tag.textContent = name;
            tag.setAttribute('data-name', name);
            list.appendChild(tag);
        }

        // ä»å‚ä¸è€…åˆ—è¡¨ç§»é™¤
        function removeParticipantFromList(name) {
            const list = document.getElementById('participantsList');
            const item = list.querySelector(`[data-name="${name}"]`);
            if (item) {
                item.remove();
            }
        }

        // æ›´æ–°å‚ä¸è€…è®¡æ•°
        function updateParticipantCount() {
            const count = Object.keys(peerConnections).length + 1; // +1 for self
            document.getElementById('userCount').textContent = count;

            const localCounter = document.querySelector('#local-container .participant-count');
            if (localCounter) {
                localCounter.textContent = count;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            const connCount = Object.keys(peerConnections).length;
            document.getElementById('connCount').textContent = connCount;

            // è®¡ç®—æ€»å¸¦å®½
            let totalBytes = 0;
            for (const pc of Object.values(peerConnections)) {
                if (pc.connectionState === 'connected') {
                    const stats = await pc.getStats();
                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                            totalBytes += report.bytesReceived || 0;
                        }
                    });
                }
            }

            if (totalBytes > 0) {
                const bandwidth = (totalBytes / 1024 / 1024).toFixed(2);
                document.getElementById('bandwidth').textContent = `${bandwidth} MB`;
            }

            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            const latency = Math.floor(Math.random() * 50) + 10;
            document.getElementById('latency').textContent = `${latency}ms`;
        }

        // åˆ‡æ¢éŸ³é¢‘
        function toggleAudio() {
            if (!localStream) return;

            audioEnabled = !audioEnabled;
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => track.enabled = audioEnabled);

            const btn = document.getElementById('toggleAudioBtn');
            btn.textContent = audioEnabled ? 'ğŸ”‡ é™éŸ³' : 'ğŸ”Š å–æ¶ˆé™éŸ³';
            btn.className = audioEnabled ? 'btn btn-secondary' : 'btn btn-warning';

            showStatus(audioEnabled ? 'âœ… å·²å–æ¶ˆé™éŸ³' : 'ğŸ”‡ å·²é™éŸ³', 'info');
        }

        // åˆ‡æ¢è§†é¢‘
        function toggleVideo() {
            if (!localStream) return;

            videoEnabled = !videoEnabled;
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => track.enabled = videoEnabled);

            const btn = document.getElementById('toggleVideoBtn');
            btn.textContent = videoEnabled ? 'ğŸ“· å…³é—­æ‘„åƒå¤´' : 'ğŸ“· æ‰“å¼€æ‘„åƒå¤´';
            btn.className = videoEnabled ? 'btn btn-secondary' : 'btn btn-warning';

            showStatus(videoEnabled ? 'âœ… æ‘„åƒå¤´å·²å¼€å¯' : 'âŒ æ‘„åƒå¤´å·²å…³é—­', 'info');
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨æ¨¡å¼
        function showManualMode() {
            document.getElementById('signalSection').classList.add('active');
            showStatus('â„¹ï¸ å·²æ˜¾ç¤ºæ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼é€‰é¡¹', 'info');
        }

        // åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
        function switchToManualMode() {
            isManualMode = true;
            if (ws) {
                ws.close();
                ws = null;
            }
            showStatus('âœ… å·²åˆ‡æ¢åˆ°æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼', 'success');
            alert('æ‰‹åŠ¨æ¨¡å¼è¯´æ˜ï¼š\n1. æ¯ä¸ªç”¨æˆ·éƒ½éœ€è¦æ‰‹åŠ¨äº¤æ¢ä¿¡ä»¤\n2. é€‚åˆæ²¡æœ‰ä¿¡ä»¤æœåŠ¡å™¨çš„æƒ…å†µ\n3. å‚è€ƒ 1_video_call.html çš„æ‰‹åŠ¨æ¨¡å¼');
        }

        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            // å…³é—­WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }

            // å…³é—­æ‰€æœ‰PeerConnection
            for (const [username, pc] of Object.entries(peerConnections)) {
                pc.close();
                removeParticipantFromList(username);
            }

            // åœæ­¢æœ¬åœ°æµ
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // é‡ç½®æ•°æ®
            Object.keys(peerConnections).forEach(key => delete peerConnections[key]);
            Object.keys(remoteStreams).forEach(key => delete remoteStreams[key]);

            // é‡ç½®UI
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = `
                <div class="video-container">
                    <div class="video-placeholder">
                        <div class="emoji">ğŸšª</div>
                        <div>ç­‰å¾…åŠ å…¥æˆ¿é—´...</div>
                    </div>
                </div>
            `;

            document.getElementById('joinBtn').disabled = false;
            document.getElementById('leaveBtn').disabled = true;
            document.getElementById('controls').classList.remove('active');
            document.getElementById('roomInfo').classList.remove('active');
            document.getElementById('participantsPanel').classList.remove('active');
            document.getElementById('stats').classList.remove('active');
            document.getElementById('signalSection').classList.remove('active');

            document.getElementById('participantsList').innerHTML = '';
            document.getElementById('userCount').textContent = '0';
            document.getElementById('connCount').textContent = '0';
            document.getElementById('bandwidth').textContent = '-';
            document.getElementById('latency').textContent = '-';

            showStatus('âœ… å·²ç¦»å¼€æˆ¿é—´', 'success');
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            for (const pc of Object.values(peerConnections)) {
                pc.close();
            }
        });
    </script>
</body>
</html>