<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC ç¯å¢ƒæ£€æŸ¥å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .check-section {
            padding: 30px;
        }
        .check-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-left: 4px solid #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .check-item.pass {
            background: #d1e7dd;
            border-left-color: #28a745;
        }
        .check-item.fail {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .check-item.warn {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .check-label {
            font-weight: 600;
            color: #333;
        }
        .check-status {
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-pass { background: #28a745; color: white; }
        .status-fail { background: #dc3545; color: white; }
        .status-warn { background: #ffc107; color: #333; }
        .status-pending { background: #6c757d; color: white; }

        .details {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            padding-left: 10px;
        }

        .action-buttons {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); }

        .video-preview {
            margin-top: 20px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            display: none;
        }
        .video-preview.active { display: block; }
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px 20px;
            margin: 20px 30px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
            line-height: 1.6;
        }
        .info-box strong { color: #1976d2; }

        .result-box {
            margin: 20px 30px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        .result-box.success {
            background: #d1e7dd;
            color: #155724;
            border: 2px solid #28a745;
            display: block;
        }
        .result-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” WebRTC ç¯å¢ƒæ£€æŸ¥å·¥å…·</h1>
            <p>å¿«é€Ÿè¯Šæ–­ä½ çš„æµè§ˆå™¨æ˜¯å¦æ”¯æŒ WebRTC è§†é¢‘é€šè¯</p>
        </div>

        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹æ£€æŸ¥"æŒ‰é’®<br>
            â€¢ å…è®¸æ‘„åƒå¤´æƒé™<br>
            â€¢ æŸ¥çœ‹æ£€æŸ¥ç»“æœ<br>
            â€¢ å¦‚æœå…¨éƒ¨é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•æ¼”ç¤ºé¡µé¢
        </div>

        <div class="check-section" id="checkList">
            <div class="check-item" id="check-protocol">
                <span class="check-label">è®¿é—®åè®®æ£€æŸ¥</span>
                <span class="check-status status-pending">ç­‰å¾…æ£€æŸ¥</span>
            </div>
            <div class="details" id="details-protocol"></div>

            <div class="check-item" id="check-webrtc">
                <span class="check-label">WebRTC æ”¯æŒæ£€æŸ¥</span>
                <span class="check-status status-pending">ç­‰å¾…æ£€æŸ¥</span>
            </div>
            <div class="details" id="details-webrtc"></div>

            <div class="check-item" id="check-media">
                <span class="check-label">åª’ä½“è®¾å¤‡è®¿é—®</span>
                <span class="check-status status-pending">ç­‰å¾…æ£€æŸ¥</span>
            </div>
            <div class="details" id="details-media"></div>

            <div class="check-item" id="check-camera">
                <span class="check-label">æ‘„åƒå¤´æƒé™</span>
                <span class="check-status status-pending">ç­‰å¾…æ£€æŸ¥</span>
            </div>
            <div class="details" id="details-camera"></div>

            <div class="check-item" id="check-microphone">
                <span class="check-label">éº¦å…‹é£æƒé™</span>
                <span class="check-status status-pending">ç­‰å¾…æ£€æŸ¥</span>
            </div>
            <div class="details" id="details-microphone"></div>
        </div>

        <div class="video-preview" id="videoPreview">
            <video id="testVideo" autoplay muted playsinline></video>
        </div>

        <div class="result-box" id="resultBox"></div>

        <div class="action-buttons">
            <button class="btn btn-primary" id="startCheck" onclick="startCheck()">ğŸ” å¼€å§‹æ£€æŸ¥</button>
            <button class="btn btn-success" id="openDemo" onclick="openDemo()" style="display:none;">ğŸš€ æ‰“å¼€æ¼”ç¤ºé¡µé¢</button>
        </div>
    </div>

    <script>
        let testStream = null;

        function updateCheck(id, status, details = '') {
            const item = document.getElementById(id);
            const statusEl = item.querySelector('.check-status');
            const detailsEl = document.getElementById('details-' + id.split('-')[1]);

            item.className = 'check-item ' + status;

            if (status === 'pass') {
                statusEl.textContent = 'é€šè¿‡';
                statusEl.className = 'check-status status-pass';
            } else if (status === 'fail') {
                statusEl.textContent = 'å¤±è´¥';
                statusEl.className = 'check-status status-fail';
            } else if (status === 'warn') {
                statusEl.textContent = 'è­¦å‘Š';
                statusEl.className = 'check-status status-warn';
            } else {
                statusEl.textContent = 'æ£€æŸ¥ä¸­';
                statusEl.className = 'check-status status-pending';
            }

            if (detailsEl && details) {
                detailsEl.textContent = details;
            }
        }

        async function startCheck() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            document.getElementById('startCheck').disabled = true;
            document.getElementById('resultBox').className = 'result-box';
            document.getElementById('videoPreview').className = 'video-preview';

            // 1. æ£€æŸ¥åè®®
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            if (protocol === 'file:') {
                updateCheck('check-protocol', 'fail', 'å½“å‰ä½¿ç”¨ file:// åè®®ï¼Œæ— æ³•è®¿é—®æ‘„åƒå¤´');
                showResult('error', 'âŒ å¤±è´¥ï¼šè¯·ä½¿ç”¨ http://localhost:8000 è®¿é—®');
                finishCheck();
                return;
            } else if (protocol === 'http:' && !isLocalhost) {
                updateCheck('check-protocol', 'warn', 'å½“å‰ä½¿ç”¨élocalhostçš„HTTPè®¿é—®ï¼Œå¯èƒ½è¢«æµè§ˆå™¨é™åˆ¶');
            } else {
                updateCheck('check-protocol', 'pass', `åè®®: ${protocol}, ä¸»æœº: ${hostname}`);
            }

            // 2. æ£€æŸ¥WebRTCæ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateCheck('check-webrtc', 'fail', 'æµè§ˆå™¨ä¸æ”¯æŒ WebRTC æˆ– getUserMedia');
                showResult('error', 'âŒ å¤±è´¥ï¼šæµè§ˆå™¨ä¸æ”¯æŒ WebRTC');
                finishCheck();
                return;
            }
            updateCheck('check-webrtc', 'pass', 'WebRTC API å¯ç”¨');

            // 3. æ£€æŸ¥åª’ä½“è®¾å¤‡
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const audioDevices = devices.filter(d => d.kind === 'audioinput');

                updateCheck('check-media', 'pass',
                    `æ‰¾åˆ° ${videoDevices.length} ä¸ªæ‘„åƒå¤´, ${audioDevices.length} ä¸ªéº¦å…‹é£`);
            } catch (e) {
                updateCheck('check-media', 'warn', 'æ— æ³•æšä¸¾è®¾å¤‡: ' + e.message);
            }

            // 4. è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£
            try {
                updateCheck('check-camera', 'warn', 'æ­£åœ¨è¯·æ±‚æƒé™...');
                updateCheck('check-microphone', 'warn', 'æ­£åœ¨è¯·æ±‚æƒé™...');

                testStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });

                // æ£€æŸ¥è§†é¢‘è½¨é“
                const videoTrack = testStream.getVideoTracks()[0];
                if (videoTrack) {
                    updateCheck('check-camera', 'pass', `æ‘„åƒå¤´æ­£å¸¸: ${videoTrack.label}`);
                } else {
                    updateCheck('check-camera', 'fail', 'æœªè·å–åˆ°è§†é¢‘è½¨é“');
                }

                // æ£€æŸ¥éŸ³é¢‘è½¨é“
                const audioTrack = testStream.getAudioTracks()[0];
                if (audioTrack) {
                    updateCheck('check-microphone', 'pass', `éº¦å…‹é£æ­£å¸¸: ${audioTrack.label}`);
                } else {
                    updateCheck('check-microphone', 'warn', 'æœªè·å–åˆ°éŸ³é¢‘è½¨é“ï¼ˆå¯èƒ½è¢«é™éŸ³ï¼‰');
                }

                // æ˜¾ç¤ºé¢„è§ˆ
                const video = document.getElementById('testVideo');
                video.srcObject = testStream;
                document.getElementById('videoPreview').className = 'video-preview active';

                showResult('success', 'âœ… å…¨éƒ¨é€šè¿‡ï¼å¯ä»¥å¼€å§‹æµ‹è¯•æ¼”ç¤ºé¡µé¢');
                document.getElementById('openDemo').style.display = 'inline-block';

            } catch (error) {
                console.error('åª’ä½“è¯·æ±‚é”™è¯¯:', error);

                if (error.name === 'NotAllowedError') {
                    updateCheck('check-camera', 'fail', 'ç”¨æˆ·æ‹’ç»äº†æ‘„åƒå¤´æƒé™');
                    updateCheck('check-microphone', 'fail', 'ç”¨æˆ·æ‹’ç»äº†éº¦å…‹é£æƒé™');
                    showResult('error', 'âŒ æƒé™è¢«æ‹’ç»ï¼šè¯·å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´');
                } else if (error.name === 'NotFoundError') {
                    updateCheck('check-camera', 'fail', 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
                    updateCheck('check-microphone', 'fail', 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡');
                    showResult('error', 'âŒ æœªæ‰¾åˆ°è®¾å¤‡ï¼šè¯·æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦è¿æ¥');
                } else {
                    updateCheck('check-camera', 'fail', error.message);
                    updateCheck('check-microphone', 'fail', error.message);
                    showResult('error', 'âŒ é”™è¯¯: ' + error.message);
                }
            }

            finishCheck();
        }

        function showResult(type, message) {
            const resultBox = document.getElementById('resultBox');
            resultBox.className = 'result-box ' + type;
            resultBox.textContent = message;
        }

        function finishCheck() {
            document.getElementById('startCheck').disabled = false;
            document.getElementById('startCheck').textContent = 'ğŸ”„ é‡æ–°æ£€æŸ¥';

            // 5ç§’ååœæ­¢è§†é¢‘é¢„è§ˆ
            setTimeout(() => {
                if (testStream) {
                    testStream.getTracks().forEach(track => track.stop());
                    testStream = null;
                }
            }, 5000);
        }

        function openDemo() {
            // å…³é—­å½“å‰è§†é¢‘æµ
            if (testStream) {
                testStream.getTracks().forEach(track => track.stop());
                testStream = null;
            }
            // æ‰“å¼€æ¼”ç¤ºé¡µé¢
            window.location.href = '1_video_call.html';
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (testStream) {
                testStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
