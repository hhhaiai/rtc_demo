<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3. ç›´æ’­æµ‹è¯• - P2På®æ—¶ç›´æ’­</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .info-box {
            background: #e3f2fd;
            padding: 15px 20px;
            margin: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
            line-height: 1.6;
        }
        .info-box strong { color: #1976d2; }

        .connection-mode {
            background: #fff3cd;
            padding: 12px 20px;
            margin: 10px 20px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            font-size: 13px;
            font-weight: 600;
            color: #856404;
            text-align: center;
        }

        .server-mode {
            background: #e3f2fd;
            padding: 15px 20px;
            margin: 10px 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
        }
        .server-mode input {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
        }

        .login-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .login-form {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        .login-form input {
            flex: 1;
            min-width: 150px;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        .login-form button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .btn-broadcaster {
            background: #e91e63;
            color: white;
        }
        .btn-broadcaster:hover:not(:disabled) {
            background: #c2185b;
            transform: translateY(-2px);
        }
        .btn-viewer {
            background: #9c27b0;
            color: white;
        }
        .btn-viewer:hover:not(:disabled) {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        .btn-leave {
            background: #dc3545;
            color: white;
        }
        .btn-leave:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .live-info {
            background: #ffebee;
            padding: 12px 20px;
            margin: 10px 20px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
            font-size: 14px;
            font-weight: 600;
            color: #c62828;
            display: none;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .live-info.active {
            display: flex;
        }
        .live-badge {
            background: #f44336;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .room-id-display {
            background: white;
            padding: 4px 10px;
            border-radius: 4px;
            color: #c62828;
            font-family: monospace;
        }

        .status {
            padding: 10px 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
            text-align: center;
        }
        .status.active { display: block; }
        .status.success { background: #d1e7dd; border-left-color: #28a745; }
        .status.error { background: #f8d7da; border-left-color: #dc3545; }
        .status.info { background: #e3f2fd; border-left-color: #2196f3; }

        .controls {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        .controls.active {
            display: block;
        }
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover:not(:disabled) { background: #e0a800; }

        .video-grid {
            display: grid;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            min-height: 300px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 2;
        }
        .participant-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(233, 30, 99, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        .connection-status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.9);
        }
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.9);
        }

        .comment-section {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        .comment-section.active {
            display: block;
        }
        .comment-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .comment-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        .comment-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .comment-input-group button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .comment-input-group button:hover {
            background: #5568d3;
        }

        .comment-list {
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }
        .comment-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
            border-left: 3px solid #667eea;
            animation: slideIn 0.3s ease-out;
        }
        .comment-item .author {
            font-weight: 700;
            color: #667eea;
            margin-right: 8px;
        }
        .comment-item .time {
            color: #999;
            font-size: 11px;
            margin-left: 8px;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .floating-comments {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .floating-comment {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: floatAcross 6s linear forwards;
            border-left: 4px solid #667eea;
        }

        @keyframes floatAcross {
            0% {
                left: -200px;
                top: 50%;
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }
            10% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            90% {
                opacity: 1;
            }
            100% {
                left: 110%;
                top: 50%;
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }
        }

        .like-animation {
            position: fixed;
            font-size: 32px;
            pointer-events: none;
            z-index: 9998;
            animation: likeFloat 2s ease-out forwards;
        }

        @keyframes likeFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translateY(-150px) scale(1.5);
                opacity: 0;
            }
        }

        .gift-animation {
            position: fixed;
            font-size: 48px;
            pointer-events: none;
            z-index: 9998;
            animation: giftBurst 3s ease-out forwards;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        @keyframes giftBurst {
            0% {
                transform: translateY(0) scale(0.5) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-100px) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-200px) scale(0.8) rotate(360deg);
                opacity: 0;
            }
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 10000;
        }
        .action-buttons.active {
            display: flex;
        }
        .action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .action-btn:active {
            transform: scale(0.9);
        }
        .like-btn {
            background: #e91e63;
            color: white;
        }
        .gift-btn {
            background: #ff9800;
            color: white;
        }
        .comment-btn {
            background: #667eea;
            color: white;
        }

        .stats {
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
            display: none;
        }
        .stats.active {
            display: flex;
        }
        .stat-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-weight: 700;
            color: #007bff;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ 3. ç›´æ’­æµ‹è¯• - P2På®æ—¶ç›´æ’­</h1>
            <p>ä¸»æ’­/è§‚ä¼—æ¨¡å¼ï¼Œæ”¯æŒå®æ—¶P2Pè¿æ¥å’Œæµ®åŠ¨è¯„è®º</p>
        </div>

        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ æœ¬é¡µé¢ä½¿ç”¨ä¿¡ä»¤æœåŠ¡å™¨è¿›è¡ŒP2Pç›´æ’­è¿æ¥<br>
            â€¢ ä¸»æ’­ï¼šå¼€å¯æ‘„åƒå¤´æ¨æµï¼Œè§‚ä¼—é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥<br>
            â€¢ è§‚ä¼—ï¼šè¾“å…¥ç›´æ’­é—´å·è§‚çœ‹ä¸»æ’­çš„å®æ—¶ç”»é¢<br>
            â€¢ æµ®åŠ¨è¯„è®ºï¼šè¯„è®ºä¼šåœ¨å±å¹•ä¸­ä»å·¦åˆ°å³é£˜è¿‡<br>
            â€¢ ç‚¹èµ/ç¤¼ç‰©ï¼šç‚¹å‡»æŒ‰é’®ä¼šæœ‰åŠ¨ç”»ç‰¹æ•ˆ<br>
            â€¢ æ³¨æ„ï¼šéœ€è¦å…ˆå¯åŠ¨ä¿¡ä»¤æœåŠ¡å™¨
        </div>

        <div class="connection-mode">
            å½“å‰æ¨¡å¼ï¼šä¿¡ä»¤æœåŠ¡å™¨P2Pç›´æ’­ï¼ˆçœŸå®è¿æ¥ï¼‰
        </div>

        <div class="server-mode">
            <strong>ä¿¡ä»¤æœåŠ¡å™¨é…ç½®ï¼š</strong><br>
            <small>å¦‚æœæ²¡æœ‰ä¿¡ä»¤æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼</small><br>
            <input type="text" id="serverUrlInput" placeholder="ws://localhost:8080" value="ws://localhost:8080">
        </div>

        <div class="login-section">
            <div class="login-form">
                <input type="text" id="usernameInput" placeholder="æ‚¨çš„ç”¨æˆ·å" maxlength="20">
                <input type="text" id="roomInput" placeholder="ç›´æ’­é—´å· (å¦‚: live1001)" maxlength="20">
                <button class="btn-broadcaster" id="broadcasterBtn" onclick="startBroadcaster()">ğŸ¤ ä¸»æ’­æ¨¡å¼</button>
                <button class="btn-viewer" id="viewerBtn" onclick="startViewer()">ğŸ‘ï¸ è§‚ä¼—æ¨¡å¼</button>
                <button class="btn-leave" id="leaveBtn" onclick="leaveLive()" disabled>ç¦»å¼€ç›´æ’­</button>
            </div>
        </div>

        <div class="live-info" id="liveInfo">
            <span>
                <span class="live-badge">ğŸ”´ LIVE</span>
                <span style="margin-left: 10px;">ç›´æ’­é—´: <span class="room-id-display" id="currentRoomId">-</span></span>
            </span>
            <span>è§‚ä¼—: <span id="userCount">0</span> äºº</span>
        </div>

        <div id="status" class="status"></div>

        <div class="controls" id="controls">
            <div class="control-group">
                <button class="btn btn-secondary" id="toggleAudioBtn" onclick="toggleAudio()">ğŸ”‡ é™éŸ³</button>
                <button class="btn btn-secondary" id="toggleVideoBtn" onclick="toggleVideo()">ğŸ“· å…³é—­æ‘„åƒå¤´</button>
            </div>
        </div>

        <div class="video-grid" id="videoGrid">
            <div class="video-container">
                <div class="video-placeholder">
                    <div class="emoji">ğŸ¥</div>
                    <div>ç­‰å¾…å¼€å§‹ç›´æ’­...</div>
                </div>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-item">è¿æ¥æ•°: <span class="stat-value" id="connCount">0</span></div>
            <div class="stat-item">å¸¦å®½: <span class="stat-value" id="bandwidth">-</span></div>
            <div class="stat-item">å»¶è¿Ÿ: <span class="stat-value" id="latency">-</span></div>
        </div>

        <div class="comment-section" id="commentSection">
            <div class="comment-input-group">
                <input type="text" id="commentInput" placeholder="è¾“å…¥è¯„è®ºå†…å®¹..." maxlength="50">
                <button onclick="sendComment()">å‘é€è¯„è®º</button>
            </div>
            <div class="comment-list" id="commentList"></div>
        </div>

        <div class="floating-comments" id="floatingComments"></div>

        <div class="action-buttons" id="actionButtons">
            <button class="action-btn like-btn" onclick="sendLike()" title="ç‚¹èµ">â¤ï¸</button>
            <button class="action-btn gift-btn" onclick="sendGift()" title="é€ç¤¼ç‰©">ğŸ</button>
            <button class="action-btn comment-btn" onclick="focusComment()" title="è¯„è®º">ğŸ’¬</button>
        </div>
    </div>

    <script>
        let localStream = null;
        let username = null;
        let roomId = null;
        let currentMode = null; // 'broadcaster' or 'viewer'
        let audioEnabled = true;
        let videoEnabled = true;

        // å­˜å‚¨æ‰€æœ‰PeerConnection
        const peerConnections = {}; // userId -> RTCPeerConnection
        const remoteStreams = {}; // userId -> MediaStream

        // ä¿¡ä»¤æœåŠ¡å™¨ç›¸å…³
        let ws = null;

        // WebRTC é…ç½®
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status active ${type}`;
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            if (protocol === 'file:') {
                showStatus('âŒ è¯·ä½¿ç”¨ http://localhost:8000 è®¿é—®', 'error');
                return false;
            }
            if (protocol === 'http:' && !isLocalhost) {
                showStatus('âŒ è¯·ä½¿ç”¨ localhost è®¿é—®', 'error');
                return false;
            }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebRTC', 'error');
                return false;
            }
            return true;
        }

        // ä¸»æ’­æ¨¡å¼ï¼šå¼€å¯æ‘„åƒå¤´å¹¶ç­‰å¾…è§‚ä¼—è¿æ¥
        async function startBroadcaster() {
            if (!checkEnvironment()) return;

            const usernameInput = document.getElementById('usernameInput');
            const roomInput = document.getElementById('roomInput');
            const serverUrlInput = document.getElementById('serverUrlInput');

            username = usernameInput.value.trim();
            roomId = roomInput.value.trim();
            const serverUrl = serverUrlInput.value.trim();

            if (!username || !roomId) {
                showStatus('âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œç›´æ’­é—´å·', 'error');
                return;
            }

            currentMode = 'broadcaster';

            try {
                showStatus('â³ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£...', 'info');

                // è¯·æ±‚æœ¬åœ°åª’ä½“
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });

                // æ¸²æŸ“æœ¬åœ°è§†é¢‘
                renderLocalVideo();

                // å°è¯•è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
                try {
                    await connectSignalingServer(serverUrl);
                    showStatus('âœ… ç›´æ’­å·²å¼€å§‹ï¼è§‚ä¼—å¯ä»¥è§‚çœ‹äº†', 'success');
                } catch (error) {
                    console.warn('ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                    showStatus('âš ï¸ ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨', 'error');
                    return;
                }

                // æ›´æ–°UI
                document.getElementById('broadcasterBtn').disabled = true;
                document.getElementById('viewerBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = false;
                document.getElementById('controls').classList.add('active');
                document.getElementById('liveInfo').classList.add('active');
                document.getElementById('commentSection').classList.add('active');
                document.getElementById('actionButtons').classList.add('active');
                document.getElementById('stats').classList.add('active');

                document.getElementById('currentRoomId').textContent = roomId;
                updateParticipantCount();

            } catch (error) {
                console.error('å¯åŠ¨ç›´æ’­å¤±è´¥:', error);
                showStatus(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è§‚ä¼—æ¨¡å¼ï¼šè¿æ¥åˆ°ä¸»æ’­
        async function startViewer() {
            if (!checkEnvironment()) return;

            const usernameInput = document.getElementById('usernameInput');
            const roomInput = document.getElementById('roomInput');
            const serverUrlInput = document.getElementById('serverUrlInput');

            username = usernameInput.value.trim();
            roomId = roomInput.value.trim();
            const serverUrl = serverUrlInput.value.trim();

            if (!username || !roomId) {
                showStatus('âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œç›´æ’­é—´å·', 'error');
                return;
            }

            currentMode = 'viewer';

            try {
                showStatus('â³ æ­£åœ¨è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨...', 'info');

                // è§‚ä¼—ä¸éœ€è¦æœ¬åœ°æ‘„åƒå¤´ï¼Œä½†éœ€è¦è¿æ¥æœåŠ¡å™¨
                await connectSignalingServer(serverUrl);

                // æ›´æ–°UI
                document.getElementById('broadcasterBtn').disabled = true;
                document.getElementById('viewerBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = false;
                document.getElementById('commentSection').classList.add('active');
                document.getElementById('actionButtons').classList.add('active');
                document.getElementById('stats').classList.add('active');

                document.getElementById('currentRoomId').textContent = roomId;
                document.getElementById('liveInfo').classList.add('active');

                showStatus('âœ… å·²è¿æ¥ï¼Œç­‰å¾…ä¸»æ’­ç”»é¢...', 'success');

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showStatus(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸²æŸ“æœ¬åœ°è§†é¢‘ï¼ˆä¸»æ’­ï¼‰
        function renderLocalVideo() {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '';

            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = 'local-container';
            container.innerHTML = `
                <div class="video-label">ğŸ¤ ${username} (ä¸»æ’­)</div>
                <div class="participant-count" id="viewerCounter">0</div>
                <div class="connection-status connected">ç›´æ’­ä¸­</div>
                <video id="localVideo" autoplay muted playsinline></video>
            `;
            grid.appendChild(container);

            const video = document.getElementById('localVideo');
            video.srcObject = localStream;
        }

        // æ¸²æŸ“è¿œç¨‹è§†é¢‘ï¼ˆè§‚ä¼—çœ‹åˆ°çš„ä¸»æ’­ç”»é¢ï¼‰
        function renderRemoteVideo(userId, stream) {
            const grid = document.getElementById('videoGrid');

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existing = document.getElementById(`remote-${userId}`);
            if (existing) {
                const video = existing.querySelector('video');
                video.srcObject = stream;
                return;
            }

            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `remote-${userId}`;
            container.innerHTML = `
                <div class="video-label">ğŸ¥ ${userId} (ä¸»æ’­)</div>
                <div class="connection-status connected">å·²è¿æ¥</div>
                <video autoplay playsinline></video>
            `;
            grid.appendChild(container);

            const video = container.querySelector('video');
            video.srcObject = stream;

            // æ›´æ–°è®¡æ•°
            updateParticipantCount();
        }

        // è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
        function connectSignalingServer(serverUrl) {
            return new Promise((resolve, reject) => {
                try {
                    ws = new WebSocket(serverUrl);

                    ws.onopen = () => {
                        console.log('ä¿¡ä»¤æœåŠ¡å™¨å·²è¿æ¥');
                        // å‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
                        ws.send(JSON.stringify({
                            type: 'join',
                            username: username,
                            roomId: roomId,
                            role: currentMode // broadcaster æˆ– viewer
                        }));
                    };

                    ws.onmessage = async (event) => {
                        const message = JSON.parse(event.data);
                        console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

                        switch (message.type) {
                            case 'peerJoined':
                                // æœ‰æ–°è§‚ä¼—åŠ å…¥ï¼ˆä¸»æ’­ç«¯ï¼‰
                                if (currentMode === 'broadcaster' && message.username !== username) {
                                    await createStreamToViewer(message.username);
                                    showStatus(`âœ… è§‚ä¼— ${message.username} å·²åŠ å…¥`, 'success');
                                }
                                break;

                            case 'peerLeft':
                                // ç”¨æˆ·ç¦»å¼€
                                removePeer(message.username);
                                break;

                            case 'offer':
                                // æ”¶åˆ°Offerï¼ˆè§‚ä¼—ç«¯ï¼‰
                                if (message.to === username && currentMode === 'viewer') {
                                    await handleOffer(message.from, message.sdp);
                                }
                                break;

                            case 'answer':
                                // æ”¶åˆ°Answerï¼ˆä¸»æ’­ç«¯ï¼‰
                                if (message.to === username && currentMode === 'broadcaster') {
                                    await handleAnswer(message.from, message.sdp);
                                }
                                break;

                            case 'iceCandidate':
                                // æ”¶åˆ°ICEå€™é€‰
                                if (message.to === username) {
                                    await handleIceCandidate(message.from, message.candidate);
                                }
                                break;

                            case 'peers':
                                // å½“å‰æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                                if (message.peers) {
                                    const count = message.peers.length;
                                    updateViewerCount(count);
                                }
                                break;

                            case 'comment':
                                // æ”¶åˆ°è¯„è®º
                                if (message.roomId === roomId) {
                                    addComment(message.username, message.text, true);
                                    addFloatingComment(message.text);
                                }
                                break;

                            case 'like':
                                // æ”¶åˆ°ç‚¹èµ
                                if (message.roomId === roomId) {
                                    createLikeAnimation();
                                }
                                break;

                            case 'gift':
                                // æ”¶åˆ°ç¤¼ç‰©
                                if (message.roomId === roomId) {
                                    createGiftAnimation();
                                    addComment('ç³»ç»Ÿ', `ğŸ‰ ${message.username} é€å‡ºäº†ç¤¼ç‰©ï¼`, true);
                                }
                                break;

                            case 'error':
                                showStatus(`âŒ ${message.message}`, 'error');
                                break;
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        reject(error);
                    };

                    ws.onclose = () => {
                        console.log('ä¿¡ä»¤æœåŠ¡å™¨å·²æ–­å¼€');
                        showStatus('âš ï¸ ä¿¡ä»¤æœåŠ¡å™¨æ–­å¼€', 'error');
                    };

                    resolve();

                } catch (error) {
                    reject(error);
                }
            });
        }

        // ä¸»æ’­ï¼šåˆ›å»ºæµåˆ°æŒ‡å®šè§‚ä¼—
        async function createStreamToViewer(targetUsername) {
            if (!localStream) {
                console.error('æœ¬åœ°æµæœªå‡†å¤‡');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿æ¥ï¼Œé¿å…é‡å¤åˆ›å»º
            if (peerConnections[targetUsername]) {
                console.log(`ä¸ ${targetUsername} çš„è¿æ¥å·²å­˜åœ¨`);
                return;
            }

            console.log(`æ­£åœ¨ä¸ºè§‚ä¼— ${targetUsername} åˆ›å»ºæµ...`);

            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[targetUsername] = pc;

            // æ·»åŠ æœ¬åœ°æµ
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // ç›‘å¬ICEå€™é€‰
            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'iceCandidate',
                        from: username,
                        to: targetUsername,
                        candidate: event.candidate
                    }));
                }
            };

            // ç›‘å¬è¿æ¥çŠ¶æ€
            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log(`${targetUsername} è¿æ¥çŠ¶æ€: ${state}`);
                updateStats();

                if (state === 'connected') {
                    updateParticipantCount();
                    showStatus(`âœ… ä¸ ${targetUsername} è¿æ¥æˆåŠŸ`, 'success');
                } else if (state === 'disconnected' || state === 'failed') {
                    showStatus(`âš ï¸ ä¸ ${targetUsername} è¿æ¥æ–­å¼€`, 'error');
                }
            };

            // åˆ›å»ºOffer
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // å‘é€Offer
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'offer',
                    from: username,
                    to: targetUsername,
                    sdp: pc.localDescription.sdp
                }));
                console.log(`å·²å‘é€Offerç»™è§‚ä¼— ${targetUsername}`);
            }
        }

        // è§‚ä¼—ï¼šå¤„ç†Offer
        async function handleOffer(fromUsername, remoteSdp) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿æ¥
            if (peerConnections[fromUsername]) {
                console.log(`ä¸ ${fromUsername} çš„è¿æ¥å·²å­˜åœ¨ï¼Œå¿½ç•¥é‡å¤Offer`);
                return;
            }

            console.log(`æ­£åœ¨å¤„ç†ä¸»æ’­ ${fromUsername} çš„Offer...`);

            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[fromUsername] = pc;

            // ç›‘å¬è¿œç¨‹æµ
            pc.ontrack = (event) => {
                console.log(`æ”¶åˆ° ${fromUsername} çš„æµ`, event.streams);
                const stream = event.streams[0];
                if (!remoteStreams[fromUsername]) {
                    remoteStreams[fromUsername] = stream;
                    renderRemoteVideo(fromUsername, stream);
                    showStatus('âœ… å·²æ”¶åˆ°ä¸»æ’­ç”»é¢', 'success');
                }
            };

            // ç›‘å¬ICEå€™é€‰
            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'iceCandidate',
                        from: username,
                        to: fromUsername,
                        candidate: event.candidate
                    }));
                }
            };

            // ç›‘å¬è¿æ¥çŠ¶æ€
            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log(`${fromUsername} è¿æ¥çŠ¶æ€: ${state}`);
                updateStats();
            };

            // è®¾ç½®è¿œç¨‹Description
            await pc.setRemoteDescription(new RTCSessionDescription({
                type: 'offer',
                sdp: remoteSdp
            }));

            // åˆ›å»ºAnswer
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            // å‘é€Answer
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'answer',
                    from: username,
                    to: fromUsername,
                    sdp: pc.localDescription.sdp
                }));
                console.log(`å·²å‘é€Answerç»™ä¸»æ’­ ${fromUsername}`);
            }
        }

        // ä¸»æ’­ï¼šå¤„ç†Answer
        async function handleAnswer(fromUsername, remoteSdp) {
            const pc = peerConnections[fromUsername];
            if (!pc) {
                console.error(`æœªæ‰¾åˆ°PeerConnection: ${fromUsername}`);
                return;
            }

            await pc.setRemoteDescription(new RTCSessionDescription({
                type: 'answer',
                sdp: remoteSdp
            }));

            console.log(`ä¸ ${fromUsername} çš„è¿æ¥å»ºç«‹å®Œæˆ`);
        }

        // å¤„ç†ICEå€™é€‰
        async function handleIceCandidate(fromUsername, candidate) {
            const pc = peerConnections[fromUsername];
            if (!pc) {
                console.error(`æœªæ‰¾åˆ°PeerConnection: ${fromUsername}`);
                return;
            }

            try {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (error) {
                console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', error);
            }
        }

        // ç§»é™¤Peer
        function removePeer(username) {
            const pc = peerConnections[username];
            if (pc) {
                pc.close();
                delete peerConnections[username];
            }

            const stream = remoteStreams[username];
            if (stream) {
                delete remoteStreams[username];
            }

            // ä»UIç§»é™¤
            const container = document.getElementById(`remote-${username}`);
            if (container) {
                container.remove();
            }

            updateParticipantCount();
            updateStats();

            showStatus(`âš ï¸ ${username} å·²ç¦»å¼€`, 'info');
        }

        // æ›´æ–°å‚ä¸è€…è®¡æ•°
        function updateParticipantCount() {
            const count = Object.keys(peerConnections).length;
            document.getElementById('userCount').textContent = count;

            const localCounter = document.getElementById('viewerCounter');
            if (localCounter) {
                localCounter.textContent = count;
            }
        }

        // æ›´æ–°è§‚ä¼—è®¡æ•°ï¼ˆä¸»æ’­ç«¯ï¼‰
        function updateViewerCount(count) {
            document.getElementById('userCount').textContent = count;
            const localCounter = document.getElementById('viewerCounter');
            if (localCounter) {
                localCounter.textContent = count;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            const connCount = Object.keys(peerConnections).length;
            document.getElementById('connCount').textContent = connCount;

            // è®¡ç®—æ€»å¸¦å®½
            let totalBytes = 0;
            for (const pc of Object.values(peerConnections)) {
                if (pc.connectionState === 'connected') {
                    const stats = await pc.getStats();
                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                            totalBytes += report.bytesReceived || 0;
                        }
                    });
                }
            }

            if (totalBytes > 0) {
                const bandwidth = (totalBytes / 1024 / 1024).toFixed(2);
                document.getElementById('bandwidth').textContent = `${bandwidth} MB`;
            }

            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            const latency = Math.floor(Math.random() * 50) + 10;
            document.getElementById('latency').textContent = `${latency}ms`;
        }

        // åˆ‡æ¢éŸ³é¢‘
        function toggleAudio() {
            if (!localStream || currentMode !== 'broadcaster') return;

            audioEnabled = !audioEnabled;
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => track.enabled = audioEnabled);

            const btn = document.getElementById('toggleAudioBtn');
            btn.textContent = audioEnabled ? 'ğŸ”‡ é™éŸ³' : 'ğŸ”Š å–æ¶ˆé™éŸ³';
            btn.className = audioEnabled ? 'btn btn-secondary' : 'btn btn-warning';

            showStatus(audioEnabled ? 'âœ… å·²å–æ¶ˆé™éŸ³' : 'ğŸ”‡ å·²é™éŸ³', 'info');
        }

        // åˆ‡æ¢è§†é¢‘
        function toggleVideo() {
            if (!localStream || currentMode !== 'broadcaster') return;

            videoEnabled = !videoEnabled;
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => track.enabled = videoEnabled);

            const btn = document.getElementById('toggleVideoBtn');
            btn.textContent = videoEnabled ? 'ğŸ“· å…³é—­æ‘„åƒå¤´' : 'ğŸ“· æ‰“å¼€æ‘„åƒå¤´';
            btn.className = videoEnabled ? 'btn btn-secondary' : 'btn btn-warning';

            showStatus(videoEnabled ? 'âœ… æ‘„åƒå¤´å·²å¼€å¯' : 'âŒ æ‘„åƒå¤´å·²å…³é—­', 'info');
        }

        // å‘é€è¯„è®º
        function sendComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();

            if (!text) return;

            // æœ¬åœ°æ˜¾ç¤º
            addComment('æ‚¨', text, false);
            addFloatingComment(text);

            // é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å¹¿æ’­
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'comment',
                    username: username,
                    roomId: roomId,
                    text: text
                }));
            }

            input.value = '';
        }

        // å‘é€ç‚¹èµ
        function sendLike() {
            // æœ¬åœ°åŠ¨ç”»
            createLikeAnimation();

            // é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å¹¿æ’­
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'like',
                    username: username,
                    roomId: roomId
                }));
            }
        }

        // å‘é€ç¤¼ç‰©
        function sendGift() {
            // æœ¬åœ°åŠ¨ç”»å’Œé€šçŸ¥
            createGiftAnimation();
            addComment('ç³»ç»Ÿ', `ğŸ‰ æ‚¨é€å‡ºäº†ç¤¼ç‰©ï¼`, false);

            // é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å¹¿æ’­
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'gift',
                    username: username,
                    roomId: roomId
                }));
            }

            showStatus('ğŸ‰ ç¤¼ç‰©å·²é€å‡ºï¼', 'success');
        }

        // æ·»åŠ è¯„è®ºåˆ°åˆ—è¡¨
        function addComment(author, text, isSimulated = false) {
            const list = document.getElementById('commentList');
            const item = document.createElement('div');
            item.className = 'comment-item';

            const time = new Date().toLocaleTimeString().substring(0, 5);
            item.innerHTML = `
                <span class="author">${author}</span>
                <span>${text}</span>
                <span class="time">${time}</span>
            `;

            list.appendChild(item);
            list.scrollTop = list.scrollHeight;

            // é™åˆ¶æ•°é‡
            while (list.children.length > 20) {
                list.removeChild(list.firstChild);
            }
        }

        // æ·»åŠ æµ®åŠ¨è¯„è®º
        function addFloatingComment(text) {
            const container = document.getElementById('floatingComments');
            const comment = document.createElement('div');
            comment.className = 'floating-comment';
            comment.textContent = text;

            // éšæœºå‚ç›´ä½ç½®ï¼ˆ20%-80%ï¼‰
            const randomTop = 20 + Math.random() * 60;
            comment.style.top = randomTop + '%';

            // éšæœºå»¶è¿Ÿ
            const randomDelay = Math.random() * 0.5;
            comment.style.animationDelay = randomDelay + 's';

            container.appendChild(comment);

            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                if (comment.parentNode) {
                    comment.parentNode.removeChild(comment);
                }
            }, 6500);
        }

        // åˆ›å»ºç‚¹èµåŠ¨ç”»
        function createLikeAnimation() {
            const container = document.getElementById('floatingComments');
            const like = document.createElement('div');
            like.className = 'like-animation';
            like.textContent = 'â¤ï¸';

            // éšæœºä½ç½®
            const randomLeft = 20 + Math.random() * 60;
            const randomBottom = 10 + Math.random() * 30;
            like.style.left = randomLeft + '%';
            like.style.bottom = randomBottom + 'px';

            container.appendChild(like);

            setTimeout(() => {
                if (like.parentNode) {
                    like.parentNode.removeChild(like);
                }
            }, 2000);
        }

        // åˆ›å»ºç¤¼ç‰©åŠ¨ç”»
        function createGiftAnimation() {
            const container = document.getElementById('floatingComments');
            const gift = document.createElement('div');
            gift.className = 'gift-animation';
            gift.textContent = 'ğŸ';

            // éšæœºä½ç½®
            const randomLeft = 30 + Math.random() * 40;
            const randomBottom = 20 + Math.random() * 40;
            gift.style.left = randomLeft + '%';
            gift.style.bottom = randomBottom + 'px';

            container.appendChild(gift);

            setTimeout(() => {
                if (gift.parentNode) {
                    gift.parentNode.removeChild(gift);
                }
            }, 3000);
        }

        // èšç„¦è¯„è®ºè¾“å…¥æ¡†
        function focusComment() {
            document.getElementById('commentInput').focus();
        }

        // ç¦»å¼€ç›´æ’­
        function leaveLive() {
            // å…³é—­WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }

            // å…³é—­æ‰€æœ‰PeerConnection
            for (const [username, pc] of Object.entries(peerConnections)) {
                pc.close();
            }

            // åœæ­¢æœ¬åœ°æµ
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // é‡ç½®æ•°æ®
            Object.keys(peerConnections).forEach(key => delete peerConnections[key]);
            Object.keys(remoteStreams).forEach(key => delete remoteStreams[key]);

            // é‡ç½®UI
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = `
                <div class="video-container">
                    <div class="video-placeholder">
                        <div class="emoji">ğŸ¥</div>
                        <div>ç­‰å¾…å¼€å§‹ç›´æ’­...</div>
                    </div>
                </div>
            `;

            document.getElementById('broadcasterBtn').disabled = false;
            document.getElementById('viewerBtn').disabled = false;
            document.getElementById('leaveBtn').disabled = true;
            document.getElementById('controls').classList.remove('active');
            document.getElementById('liveInfo').classList.remove('active');
            document.getElementById('commentSection').classList.remove('active');
            document.getElementById('actionButtons').classList.remove('active');
            document.getElementById('stats').classList.remove('active');

            document.getElementById('participantsList').innerHTML = '';
            document.getElementById('userCount').textContent = '0';
            document.getElementById('connCount').textContent = '0';
            document.getElementById('bandwidth').textContent = '-';
            document.getElementById('latency').textContent = '-';

            // æ¸…ç©ºè¯„è®º
            document.getElementById('commentList').innerHTML = '';
            document.getElementById('floatingComments').innerHTML = '';

            showStatus('âœ… å·²ç¦»å¼€ç›´æ’­', 'success');
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            for (const pc of Object.values(peerConnections)) {
                pc.close();
            }
        });

        // å›è½¦å‘é€è¯„è®º
        document.addEventListener('DOMContentLoaded', () => {
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendComment();
                    }
                });
            }
        });
    </script>
</body>
</html>
