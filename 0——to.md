æˆ‘ç°åœ¨æœ‰ä¸€ä¸ªå³æ—¶é€šè®¯è½¯ä»¶ï¼Œç¤¾äº¤è½¯ä»¶ï¼Œç°åœ¨é›†æˆäº†å£°ç½‘è¯­éŸ³ï¼Œå¸Œæœ›åŸºäºå¼€æºæŠ€æœ¯ï¼Œæ‰“ç®—å¼€å‘ä¸€ä¸ªç»„ä»¶ï¼Œ æ”¯æŒä¸ªäººå’Œç¾¤èŠè¯­éŸ³ã€ä¸ªäººå’Œç¾¤èŠè§†é¢‘ã€ç±»ä¼¼zoomè…¾è®¯ä¼šè®®çš„å¤šäººè§†é¢‘æˆ–è¯­éŸ³ä¼šè®®ï¼Œç›´æ’­ ï¼Œä¹‹å‰æ¢³ç†äº†å‡ ä¸ªæ–‡æ¡£ï¼Œè¯·æ‚¨å¸®æˆ‘æ¢³ç†å‡ºä¸€ä¸ªæ€»è§ˆè®¾è®¡ï¼Œæˆ‘åŸºäºè¿™ä¸ªæ€»è§ˆï¼Œå¼€å§‹è®©AIå¼€å§‹å·¥ä½œç¼–å†™æœåŠ¡ç«¯ä»£ç ï¼Œå®¢æˆ·ç«¯ä»£ç 

ç°åœ¨ç§»åŠ¨ç«¯æˆ‘ä»¬ç”¨çš„æ˜¯RNï¼ŒPCç«¯æˆ‘ä»¬ç”¨çš„æ˜¯electron
------------
é¡¹ç›®åç§°ï¼šLiveKit
GitHub åœ°å€ï¼šhttps://github.com/livekit/livekit
æ ¸å¿ƒä¼˜åŠ¿ï¼šSDK æœ€å…¨ï¼Œå¼€å‘ä½“éªŒæœ€å¥½ï¼ŒGo è¯­è¨€é«˜æ€§èƒ½ã€‚
é€‚åˆåœºæ™¯ï¼šç¤¾äº¤ Appã€å³æ—¶é€šè®¯ã€å³æ„/å£°ç½‘çš„å¼€æºæ›¿ä»£ã€‚


é¡¹ç›®åç§°ï¼šSRS
GitHub åœ°å€ï¼šhttps://github.com/ossrs/srs
æ ¸å¿ƒä¼˜åŠ¿ï¼šç›´æ’­ä¸ RTC èåˆæœ€å¼ºï¼Œæ”¯æŒ RTMP/FLV/HLSã€‚
é€‚åˆåœºæ™¯ï¼šç§€åœºç›´æ’­ã€å¸¦è¿éº¦çš„ç›´æ’­ã€å¤§è§„æ¨¡æ¨æµã€‚


é¡¹ç›®åç§°ï¼šmediasoup
GitHub åœ°å€ï¼šhttps://github.com/versatica/mediasoup
æ ¸å¿ƒä¼˜åŠ¿ï¼šNode.js ç”Ÿæ€æå…¶å‹å¥½ï¼Œåº•å±‚ C++ æ€§èƒ½æè‡´ã€‚
é€‚åˆåœºæ™¯ï¼šæ·±åº¦å®šåˆ¶åç«¯é€»è¾‘ã€å·²æœ‰ Node.js æ¶æ„é›†æˆã€‚


é¡¹ç›®åç§°ï¼šJitsi Meet
GitHub åœ°å€ï¼šhttps://github.com/jitsi/jitsi-meet
æ ¸å¿ƒä¼˜åŠ¿ï¼šè‡ªå¸¦å®Œæ•´ UI çš„ä¼šè®®ç³»ç»Ÿï¼ŒåŠŸèƒ½æœ€ç°æˆã€‚
é€‚åˆåœºæ™¯ï¼šè§†é¢‘ä¼šè®®å·¥å…·ï¼ˆå¦‚ Zoom ç«å“ï¼‰ã€‚

---------


## ğŸ” **ç¬¬ä¸€å±‚ï¼šæ¶æ„å¯è¡Œæ€§éªŒè¯** âœ…

Spring Boot åº”ç”¨æœåŠ¡å™¨å¯ä»¥æ¶ˆè´¹ Kurento Java Client API æ¥æ§åˆ¶ Kurento Media Server åŠŸèƒ½ï¼Œè¿™å·²åœ¨å®˜æ–¹æ•™ç¨‹ä¸­å¾—åˆ°éªŒè¯ã€‚

ä½¿ç”¨ä¸¤ä¸ª WebSocketï¼šä¸€ä¸ªåœ¨å®¢æˆ·ç«¯å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´å®ç°è‡ªå®šä¹‰ä¿¡ä»¤åè®®ï¼Œå¦ä¸€ä¸ªåœ¨ Kurento Java Client å’Œ Kurento Media Server ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚

**ç»“è®ºï¼šâœ… Java åç«¯é›†æˆ Kurento å·²æœ‰æˆç†Ÿçš„å‚è€ƒæ¶æ„**

---

## ğŸ” **ç¬¬äºŒå±‚ï¼šå‰ç«¯æŠ€æœ¯æ ˆæ”¯æŒéªŒè¯** âœ…

### React Native æ”¯æŒ

React Native æ¡†æ¶æ”¯æŒ WebRTC é›†æˆï¼ŒWebRTC 1.0 ä¿è¯ä¸ Android OS ä¸Š React Native æ··åˆåº”ç”¨çš„å…¼å®¹æ€§ã€‚

### Electron æ”¯æŒ

Electron æ¡†æ¶å¯ä»¥ç”¨äºæ„å»º WebRTC æ··åˆæ¡Œé¢åº”ç”¨ï¼Œå…¼å®¹ Windows å’Œæ ‘è“æ´¾å¹³å°ã€‚

**ç»“è®ºï¼šâœ… RN + Electron åŒç«¯éƒ½æœ‰ WebRTC æ”¯æŒä¸”ç»è¿‡æµ‹è¯•**

---

## ğŸ” **ç¬¬ä¸‰å±‚ï¼šä¿¡ä»¤åè®®å…¼å®¹æ€§éªŒè¯** âœ…

SDP å’Œ ICE candidates éœ€è¦åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´äº¤æ¢ä»¥å»ºç«‹ WebRTC ä¼šè¯ï¼ŒSDP åå•†è¿æ¥æµè§ˆå™¨ä¸­çš„ WebRtcPeer å’ŒæœåŠ¡å™¨ä¸­çš„ WebRtcEndpointã€‚

è¿™æ„å‘³ç€æ‚¨çš„**ç°æœ‰ IM ä¿¡ä»¤æ¶æ„å¯ä»¥ç›´æ¥å¤ç”¨**æ¥ä¼ è¾“ WebRTC çš„ SDP/ICEã€‚

**ç»“è®ºï¼šâœ… å¯ä»¥å¤ç”¨ç°æœ‰ IM ä¿¡ä»¤åŸºç¡€è®¾æ–½**

---

## ğŸ” **ç¬¬å››å±‚ï¼šç”Ÿäº§ç¯å¢ƒéªŒè¯** âœ…

### å¹¶å‘æ€§èƒ½

100 ä¸ªç”¨æˆ·åœ¨ t2.small æœºå™¨ä¸Šè¿è¡Œè‰¯å¥½ï¼Œ70-80 ä¸ªçœŸå®æ¼”è®²è€…å¸¦å½•åˆ¶ã€4-5 ä¸ªè§‚ä¼—éœ€è¦æ›´å¼ºæœºå™¨ï¼ˆr3.largeï¼‰ï¼Œç°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œæ— ä»»ä½•é—®é¢˜ã€‚

å·²è®¡åˆ’å¯¹æ°´å¹³æ‰©å±•çš„ Kurento æœåŠ¡å™¨è¿›è¡Œ 5000+ ç”¨æˆ·çš„è´Ÿè½½æµ‹è¯•ã€‚

### ç¨³å®šæ€§

KMS v6.0 è¢«è®¤ä¸ºæ˜¯ç¬¬ä¸€ä¸ªçœŸæ­£ç”Ÿäº§å°±ç»ªçš„ç‰ˆæœ¬ï¼Œæä¾›äº†é€‚åˆé›†æˆåˆ°ç”Ÿäº§ç³»ç»Ÿçš„ç‰¹æ€§ã€‚

**ç»“è®ºï¼šâœ… ç”Ÿäº§æ¡ˆä¾‹å­˜åœ¨ï¼Œæ€§èƒ½æŒ‡æ ‡æ˜ç¡®**

---

## ğŸ” **ç¬¬äº”å±‚ï¼šåŠŸèƒ½å®Œæ•´æ€§éªŒè¯** âœ…

Kurento å®˜æ–¹æ•™ç¨‹ä¸­å·²æœ‰ä»¥ä¸‹å®ç°ï¼š

| åŠŸèƒ½  | å®˜æ–¹æ•™ç¨‹ | é€‚é…çŠ¶æ€ |
| --- | --- | --- |
| **1v1 è§†é¢‘é€šè¯** | One-to-one æ•™ç¨‹ï¼šç”¨æˆ· A è§†é¢‘æµå‘é€åˆ° KMSï¼ŒKMS è½¬å‘ç»™ç”¨æˆ· Bï¼›B ä¹Ÿè½¬å‘ç»™ Aï¼ŒKMS æä¾› B2B å‘¼å«æœåŠ¡ | âœ…   |
| **å¤šäººä¼šè®®** | Group Call æ•™ç¨‹ï¼šæ¯ä¸ªæˆ¿é—´åˆ›å»ºè‡ªå·±çš„ç®¡é“ï¼ŒåŒä¸€æˆ¿é—´çš„å®¢æˆ·ç«¯åªèƒ½ç›¸äº’äº¤æ¢åª’ä½“ | âœ…   |
| **ç›´æ’­å¹¿æ’­** | One-to-many æ•™ç¨‹ï¼š1 ä¸ªæ¼”è®²è€… + N ä¸ªè§‚ä¼—ï¼Œç”± 1+N ä¸ªäº’è¿çš„ WebRtcEndpoints ç»„æˆ | âœ…   |
| **åª’ä½“å¤„ç†** | Kurento æä¾› WebRTCã€RTP æ”¶å‘å™¨ã€éŸ³è§†é¢‘æ··åˆå™¨ã€åª’ä½“å½•åˆ¶ç­‰æ„å»ºå—ï¼Œè¿™äº›åª’ä½“å…ƒç´ æ˜“äºç»„åˆ | âœ…   |

**ç»“è®ºï¼šâœ… æ‰€æœ‰åŠŸèƒ½éƒ½å·²å®˜æ–¹éªŒè¯**

---

## ğŸ” **ç¬¬å…­å±‚ï¼šéƒ¨ç½²å’Œå¯ç»´æŠ¤æ€§éªŒè¯** âœ…

### éƒ¨ç½²

KMS å¯ä»¥éƒ¨ç½²åœ¨æœ¬åœ°æˆ–äº‘ç«¯ï¼Œå¯é›†æˆåˆ°ä»å°å‹å¼€å‘è®¾ç½®åˆ°å¤§è§„æ¨¡ç”Ÿäº§ç³»ç»Ÿçš„å„ç§ç¯å¢ƒï¼Œæ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆå¦‚ Dockerï¼‰ã€‚

### å¼€æºå¯æ§

å¼€æºé¡¹ç›®ï¼Œæºä»£ç ä»¥ Apache License Version 2.0 æ¡æ¬¾å‘å¸ƒå¹¶åœ¨ GitHub ä¸Šæä¾›ã€‚

Kurento å¼€å‘å›¢é˜ŸåŠ å…¥ Twilioï¼ŒKurento æœ¬èº«ä»æœ‰å°ç‰ˆæœ¬æ›´æ–°ï¼Œæ–°ç‰ˆæœ¬ä»åœ¨å‘å¸ƒä¸­ã€‚

**ç»“è®ºï¼šâœ… å¼€æºåè®®å‹å¥½ã€æŒç»­ç»´æŠ¤ã€å®¹å™¨åŒ–éƒ¨ç½²**

---

## ğŸ¯ **æœ€ç»ˆéªŒè¯ç»“è®º**

### âœ… è¿™å¥—æ–¹æ¡ˆ **100% å¯ä»¥å·¥ä½œ**

**åŸå› æ˜¯ï¼š**

1.  **å®˜æ–¹æ¶æ„éªŒè¯**ï¼šKurento + Spring Boot çš„ä¸‰å±‚æ¶æ„æœ‰æˆç†Ÿçš„å®˜æ–¹æ•™ç¨‹å’Œå®ç°
    
2.  **å‰ç«¯å…¼å®¹æ€§**ï¼šRN + Electron éƒ½æœ‰å®Œæ•´çš„ WebRTC æ”¯æŒåº“
    
3.  **ä¿¡ä»¤å¤ç”¨**ï¼šWebRTC ä¿¡ä»¤å¯å®Œå…¨å¤ç”¨æ‚¨ç°æœ‰çš„ IM åŸºç¡€è®¾æ–½
    
4.  **åŠŸèƒ½å®Œæ•´**ï¼š1v1ã€ç¾¤ç»„ã€ç›´æ’­ã€å½•åˆ¶ç­‰æ‰€æœ‰åŠŸèƒ½éƒ½æœ‰å®˜æ–¹å‚è€ƒå®ç°
    
5.  **ç”Ÿäº§éªŒè¯**ï¼šå·²æœ‰å…¬å¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œï¼Œè§„æ¨¡è¾¾æ•°åƒç”¨æˆ·
    
6.  **å¼€æºå¯æ§**ï¼šApache 2.0 åè®®ï¼Œæºä»£ç å¯æ§ï¼ŒæŒç»­ç»´æŠ¤ä¸­
    

---

## ğŸ“‹ **ç«‹å³å¯ä»¥å¼€å§‹çš„å…·ä½“æ­¥éª¤**

```text
ç¬¬ 1 å‘¨ï¼šç¯å¢ƒæ­å»º
â”œâ”€ æœ¬åœ°éƒ¨ç½² Kurento Media Server (Docker)
â”œâ”€ åˆ›å»º Spring Boot é¡¹ç›®é›†æˆ Kurento Java Client
â””â”€ è¿è¡Œå®˜æ–¹ Hello World æ•™ç¨‹éªŒè¯

ç¬¬ 2 å‘¨ï¼šä¿¡ä»¤è®¾è®¡
â”œâ”€ æ‰©å±•ç°æœ‰ IM æœåŠ¡åŠ å…¥ WebRTC ä¿¡ä»¤ç«¯ç‚¹
â”œâ”€ å®ç° SDP/ICE çš„äº¤æ¢å’Œè½¬å‘
â””â”€ å†™å•å…ƒæµ‹è¯•

ç¬¬ 3-4 å‘¨ï¼šå‰ç«¯é›†æˆ
â”œâ”€ RN ç«¯é›†æˆ react-native-webrtc åº“
â”œâ”€ Electron ç«¯é›†æˆ WebRTC API
â””â”€ å®ç°ä¸ Java æœåŠ¡çš„è¿æ¥

ç¬¬ 5 å‘¨ï¼š1v1 éŸ³è§†é¢‘é€šè¯
â”œâ”€ åŸºäºå®˜æ–¹ One-to-one æ•™ç¨‹æ”¹é€ 
â”œâ”€ ç«¯åˆ°ç«¯æµ‹è¯•
â””â”€ æ€§èƒ½åŸºå‡†æµ‹è¯•
```

----------------
## ğŸ”„ **å¤ç”¨ç°æœ‰ WebSocket æ¶æ„**

```mermaid
graph TB
    subgraph Client["ğŸ–¥ å®¢æˆ·ç«¯å±‚"]
        RN["ğŸ“± React Native<br/>ç°æœ‰WebSocketè¿æ¥<br/>+ æ–°å¢WebRTCæ¨¡å—"]
        Electron["ğŸ’» Electron<br/>ç°æœ‰WebSocketè¿æ¥<br/>+ æ–°å¢WebRTCæ¨¡å—"]
    end
    
    subgraph ExistingIM["ç°æœ‰IMç³»ç»Ÿ"]
        IMWebSocket["WebSocket Server<br/>å¤„ç†ç¤¾äº¤æ¶ˆæ¯<br/>ç”¨æˆ·åœ¨çº¿çŠ¶æ€<br/>å¥½å‹å…³ç³»"]
    end
    
    subgraph NewRTC["æ–°å¢RTCç³»ç»Ÿ"]
        RTCSignal["RTCä¿¡ä»¤æ¨¡å—<br/>SDP/ICEå¤„ç†<br/>æˆ¿é—´ç®¡ç†"]
        KMSAdapter["KMSé€‚é…å™¨<br/>JSON-RPCè°ƒç”¨"]
    end
    
    subgraph Shared["å…±äº«åŸºç¡€è®¾æ–½"]
        Redis["Redis<br/>ä¼šè¯/ç¼“å­˜<br/>åœ¨çº¿çŠ¶æ€"]
        MySQL["MySQL<br/>ç”¨æˆ·æ•°æ®"]
    end
    
    subgraph Media["åª’ä½“å±‚"]
        KMS["Kurento Media Server"]
        TURN["TURN Server<br/>Coturn"]
    end
    
    RN -->|å·²æœ‰è¿æ¥| IMWebSocket
    Electron -->|å·²æœ‰è¿æ¥| IMWebSocket
    
    IMWebSocket -->|è·¯ç”±RTCä¿¡ä»¤| RTCSignal
    RTCSignal --> KMSAdapter
    KMSAdapter --> KMS
    
    IMWebSocket --> Redis
    RTCSignal --> Redis
    
    RN -->|åª’ä½“æµ| KMS
    Electron -->|åª’ä½“æµ| KMS
    RN -->|ICEä¸­ç»§| TURN
    Electron -->|ICEä¸­ç»§| TURN
    
    style ExistingIM fill:#e3f2fd
    style NewRTC fill:#fff3cd
    style Shared fill:#f3e5f5
    style Media fill:#d4edda
```

---

## ğŸ“Š **WebSocket æ¶ˆæ¯æµè®¾è®¡**

ç”±äºæ‚¨å·²æœ‰ WebSocket è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨**åŒä¸€ä¸ª WebSocket è¿æ¥ä¸Šå¤ç”¨æ¶ˆæ¯**ï¼Œæ— éœ€å»ºç«‹ç‹¬ç«‹çš„ WebSocketï¼š

```mermaid
graph LR
    subgraph ClientMsg["å®¢æˆ·ç«¯å‘é€"]
        IMMsg["IMæ¶ˆæ¯<br/>type: 'message'"]
        StateMsg["çŠ¶æ€å˜åŒ–<br/>type: 'state'"]
        RTCMsg["ğŸ¬ RTCä¿¡ä»¤<br/>type: 'rtc'"]
    end
    
    subgraph Server["Spring Boot"]
        Router["æ¶ˆæ¯è·¯ç”±å™¨<br/>æ ¹æ® type è½¬å‘"]
        IMHandler["IMå¤„ç†å™¨<br/>ç¤¾äº¤ä¸šåŠ¡"]
        RTCHandler["RTCå¤„ç†å™¨<br/>åª’ä½“ä¸šåŠ¡"]
    end
    
    subgraph ServerMsg["æœåŠ¡å™¨è¿”å›"]
        IMResp["IMå“åº”<br/>type: 'message'"]
        RTCResp["ğŸ¬ RTCå“åº”<br/>type: 'rtc'"]
    end
    
    IMMsg --> Router
    StateMsg --> Router
    RTCMsg --> Router
    
    Router --> IMHandler
    Router --> RTCHandler
    
    IMHandler --> IMResp
    RTCHandler --> RTCResp
    
    style RTCMsg fill:#ff9800
    style RTCHandler fill:#ff9800
    style RTCResp fill:#ff9800
```

**WebSocket æ¶ˆæ¯æ ¼å¼è®¾è®¡ï¼š**

```text
IM æ¶ˆæ¯:
{
  "type": "message",
  "data": {
    "from": "user1",
    "to": "user2",
    "content": "...",
    "timestamp": 1234567890
  }
}

RTC ä¿¡ä»¤:
{
  "type": "rtc",
  "action": "offer",        // offer/answer/candidate/join/leave
  "data": {
    "roomId": "123",
    "userId": "user1",
    "sdp": "...",           // for offer/answer
    "candidate": "...",     // for candidate
    "sdpMLineIndex": 0
  }
}

çŠ¶æ€å˜åŒ–:
{
  "type": "state",
  "data": {
    "userId": "user1",
    "status": "online/offline",
    "lastSeen": 1234567890
  }
}
```

---

## ğŸ— **é‡æ–°è®¾è®¡çš„ç³»ç»Ÿæ¶æ„**

```mermaid
graph TB
    subgraph Client["å®¢æˆ·ç«¯"]
        RNApp["React Native App<br/>WebSocket Client<br/>WebRTC Client"]
        ElecApp["Electron App<br/>WebSocket Client<br/>WebRTC Client"]
    end
    
    subgraph LoadBalance["è´Ÿè½½å‡è¡¡"]
        LB["Nginx/HAProxy<br/>WebSocket ä¼šè¯ä¿æŒ<br/>Sticky Sessions"]
    end
    
    subgraph SpringBootCluster["Spring Boot åº”ç”¨é›†ç¾¤"]
        Server1["åº”ç”¨å®ä¾‹ 1"]
        Server2["åº”ç”¨å®ä¾‹ 2"]
        ServerN["åº”ç”¨å®ä¾‹ N"]
    end
    
    subgraph AppModules["åº”ç”¨å†…æ¨¡å—"]
        WSHandler["WebSocket å¤„ç†å™¨<br/>è¿æ¥ç”Ÿå‘½å‘¨æœŸ<br/>æ¶ˆæ¯è·¯ç”±"]
        
        IMLogic["IM ä¸šåŠ¡é€»è¾‘<br/>æ¶ˆæ¯å¤„ç†<br/>ç”¨æˆ·å…³ç³»"]
        
        RTCLogic["RTC ä¸šåŠ¡é€»è¾‘<br/>ä¿¡ä»¤å¤„ç†<br/>æˆ¿é—´ç®¡ç†<br/>çŠ¶æ€ç»´æŠ¤"]
        
        KMSBridge["KMS æ¡¥æ¥å™¨<br/>JSON-RPC<br/>ç«¯ç‚¹ç”Ÿå‘½å‘¨æœŸ"]
    end
    
    subgraph SharedData["å…±äº«æ•°æ®å±‚"]
        Redis1["Redis<br/>WebSocketä¼šè¯<br/>æˆ¿é—´ä¸´æ—¶æ•°æ®<br/>åœ¨çº¿ç”¨æˆ·<br/>å‘å¸ƒ-è®¢é˜…"]
        
        MySQL1["MySQL<br/>æˆ¿é—´å†å²<br/>ç”¨æˆ·æ•°æ®<br/>å½•åˆ¶è®°å½•"]
    end
    
    subgraph MediaLayer["åª’ä½“æœåŠ¡å±‚"]
        KMS["Kurento Media Server<br/>å¤„ç† WebRTC åª’ä½“"]
        TURN["TURN Server<br/>NAT ç©¿é€"]
    end
    
    RNApp --> LB
    ElecApp --> LB
    
    LB --> Server1
    LB --> Server2
    LB --> ServerN
    
    Server1 --> WSHandler
    Server2 --> WSHandler
    ServerN --> WSHandler
    
    WSHandler --> IMLogic
    WSHandler --> RTCLogic
    
    IMLogic --> Redis1
    RTCLogic --> Redis1
    RTCLogic --> KMSBridge
    
    KMSBridge --> KMS
    KMS --> TURN
    
    IMLogic --> MySQL1
    RTCLogic --> MySQL1
    
    style RTCLogic fill:#fff3cd
    style KMSBridge fill:#fff3cd
    style KMS fill:#d4edda
    style TURN fill:#d4edda
```

---

## ğŸ”Œ **å…³é”®é›†æˆç‚¹è®¾è®¡**

### **é›†æˆç‚¹ 1: WebSocket æ¶ˆæ¯è·¯ç”±**

```mermaid
graph TB
    subgraph Input["WebSocket æ¶ˆæ¯è¾“å…¥"]
        Msg["å®¢æˆ·ç«¯ JSON æ¶ˆæ¯<br/>{type, action, data}"]
    end
    
    subgraph Router["æ¶ˆæ¯è·¯ç”±å±‚"]
        Check["æ¶ˆæ¯éªŒè¯<br/>â€¢ æ ¼å¼æ£€æŸ¥<br/>â€¢ èº«ä»½è®¤è¯<br/>â€¢ æƒé™æ£€æŸ¥"]
        
        Route["ç±»å‹è·¯ç”±<br/>if type == 'rtc' â†’ RTCHandler<br/>if type == 'message' â†’ IMHandler<br/>if type == 'state' â†’ StateHandler"]
    end
    
    subgraph Handlers["ä¸šåŠ¡å¤„ç†"]
        IMHD["IM Handler<br/>è°ƒç”¨ç°æœ‰IMé€»è¾‘"]
        
        RTCHD["RTC Handler<br/>NEW - æ–°å¢RTCé€»è¾‘"]
        
        StateHD["State Handler<br/>è°ƒç”¨çŠ¶æ€ç®¡ç†"]
    end
    
    subgraph Output["æ¶ˆæ¯å“åº”"]
        Response["è¿”å›å“åº”<br/>æ¨é€ç»™å®¢æˆ·ç«¯<br/>å¹¿æ’­ç»™æˆ¿é—´"]
    end
    
    Msg --> Check
    Check --> Route
    Route --> IMHD
    Route --> RTCHD
    Route --> StateHD
    
    IMHD --> Response
    RTCHD --> Response
    StateHD --> Response
    
    style RTCHD fill:#fff3cd
```

---

### **é›†æˆç‚¹ 2: RTC ä¿¡ä»¤å¤„ç†**

```mermaid
graph TB
    subgraph Input["RTC ä¿¡ä»¤æ¶ˆæ¯"]
        Offer["offer<br/>ç”¨æˆ·Aå‘èµ·é€šè¯"]
        Answer["answer<br/>ç”¨æˆ·Bæ¥å—é€šè¯"]
        Candidate["ICE candidate<br/>è¿æ¥åœ°å€"]
        Join["join<br/>åŠ å…¥æˆ¿é—´"]
        Leave["leave<br/>ç¦»å¼€æˆ¿é—´"]
    end
    
    subgraph Process["ä¿¡ä»¤å¤„ç†æµç¨‹"]
        ValidateUser["1. éªŒè¯ç”¨æˆ·èº«ä»½<br/>ä»WebSocketä¼šè¯è·å–"]
        
        RoomCheck["2. æˆ¿é—´æ£€æŸ¥<br/>éªŒè¯æˆ¿é—´å­˜åœ¨<br/>æ£€æŸ¥æˆå‘˜æƒé™"]
        
        CreateEndpoint["3. åˆ›å»º/ç®¡ç†Endpoint<br/>è°ƒç”¨KMSåˆ›å»ºEndpoint<br/>ä¿å­˜ä¼šè¯ä¿¡æ¯"]
        
        ProcessSDP["4. å¤„ç†SDP<br/>è½¬å‘ç»™KMSå¤„ç†<br/>è·å–answer"]
        
        AddCandidate["5. è½¬å‘ICE<br/>å°†candidateè½¬å‘ç»™KMS"]
        
        CleanupRoom["6. æ¸…ç†èµ„æº<br/>é‡Šæ”¾Endpoint<br/>é”€æ¯ç©ºæˆ¿é—´"]
    end
    
    subgraph Storage["æ•°æ®å­˜å‚¨"]
        RedisSession["Redis<br/>RTCSession"]
        RedisRoom["Redis<br/>RoomMembers"]
        MySQLRecord["MySQL<br/>RoomHistory"]
    end
    
    Offer --> ValidateUser
    Answer --> ValidateUser
    Candidate --> ValidateUser
    Join --> ValidateUser
    Leave --> ValidateUser
    
    ValidateUser --> RoomCheck
    RoomCheck --> CreateEndpoint
    CreateEndpoint --> RedisSession
    CreateEndpoint --> ProcessSDP
    ProcessSDP --> AddCandidate
    ProcessSDP --> RedisRoom
    
    Candidate --> AddCandidate
    Leave --> CleanupRoom
    CleanupRoom --> MySQLRecord
    
    style ProcessSDP fill:#ff9800
    style AddCandidate fill:#ff9800
```

---

### **é›†æˆç‚¹ 3: ä¸ç°æœ‰ IM ç³»ç»Ÿçš„åä½œ**

```mermaid
graph TB
    subgraph Scenario["ä½¿ç”¨åœºæ™¯"]
        Call["å‘èµ·é€šè¯"]
        Notify["æ¥æ”¶æ–¹é€šçŸ¥"]
        History["é€šè¯è®°å½•"]
    end
    
    subgraph RTC["RTCç³»ç»Ÿ"]
        RTCCreate["åˆ›å»ºæˆ¿é—´<br/>åˆ›å»ºEndpoint"]
    end
    
    subgraph IM["ç°æœ‰IMç³»ç»Ÿ"]
        IMSend["å‘é€é€šè¯é‚€è¯·<br/>type: 'rtc_invite'"]
        IMNotify["æ¨é€æ¥ç”µé€šçŸ¥<br/>è‡³æ¥æ”¶æ–¹"]
        IMRecord["è®°å½•é€šè¯æ¶ˆæ¯<br/>åœ¨ä¼šè¯åˆ—è¡¨ä¸­"]
    end
    
    Call -->|è§¦å‘| RTCCreate
    RTCCreate -->|å›è°ƒ| IMSend
    IMSend --> IMNotify
    
    IMNotify -->|æ¥å¬/æ‹’ç»| IMRecord
    
    style RTC fill:#fff3cd
    style IM fill:#e3f2fd
```

---

## ğŸ’¾ **æ•°æ®å­˜å‚¨è®¾è®¡**

### **Redis ä¸­çš„æ•°æ®ç»“æ„**

```text
RTC ä¼šè¯æ•°æ®:
rtc:session:{sessionId}
  â”œâ”€ userId: "user1"
  â”œâ”€ roomId: "room123"
  â”œâ”€ endpointId: "endpoint_abc"
  â”œâ”€ sdpOffer: "..."
  â”œâ”€ sdpAnswer: "..."
  â”œâ”€ connectedTime: 1234567890
  â””â”€ TTL: 3600s

æˆ¿é—´æˆå‘˜åˆ—è¡¨:
rtc:room:{roomId}:members
  â”œâ”€ user1 (publisher/subscriber)
  â”œâ”€ user2 (subscriber)
  â””â”€ user3 (subscriber)

æˆ¿é—´çŠ¶æ€:
rtc:room:{roomId}:state
  â”œâ”€ roomType: "1v1" / "mcu" / "broadcast"
  â”œâ”€ createdTime: 1234567890
  â”œâ”€ mediaStarted: true/false
  â””â”€ recordingPath: "/path/to/file"

WebSocket ä¼šè¯æ˜ å°„:
ws:session:{sessionId}
  â”œâ”€ userId: "user1"
  â”œâ”€ connectionTime: 1234567890
  â”œâ”€ lastHeartbeat: 1234567890
  â””â”€ TTL: æ›´æ–°æ—¶è®¾ç½®

åœ¨çº¿ç”¨æˆ·å‘å¸ƒ-è®¢é˜…:
user:{userId}:status
  â””â”€ å‘å¸ƒçŠ¶æ€å˜åŒ–äº‹ä»¶
```

---

### **MySQL ä¸­çš„æ•°æ®è¡¨**

```text
æˆ¿é—´å†å²è¡¨:
rooms
â”œâ”€ id (ä¸»é”®)
â”œâ”€ roomId (ä¸šåŠ¡ID)
â”œâ”€ roomType (1v1/mcu/broadcast)
â”œâ”€ creator
â”œâ”€ createdTime
â”œâ”€ endedTime
â”œâ”€ status (active/ended)
â””â”€ metadata (JSON)

å½•åˆ¶å…ƒæ•°æ®è¡¨:
recordings
â”œâ”€ id
â”œâ”€ roomId
â”œâ”€ recordingFile
â”œâ”€ startTime
â”œâ”€ endTime
â”œâ”€ duration
â”œâ”€ fileSize
â”œâ”€ participants (JSON)
â””â”€ status

æˆ¿é—´æˆå‘˜è¡¨:
room_members
â”œâ”€ id
â”œâ”€ roomId
â”œâ”€ userId
â”œâ”€ joinTime
â”œâ”€ leaveTime
â”œâ”€ role (publisher/subscriber)
â””â”€ duration
```

---

## ğŸ”„ **å®Œæ•´çš„ä¿¡ä»¤äº¤äº’æµç¨‹**

### **åœºæ™¯ï¼š1v1 éŸ³è§†é¢‘é€šè¯ï¼ˆåŸºäºç°æœ‰ WebSocketï¼‰**

```mermaid
sequenceDiagram
    participant A as ç”¨æˆ·A<br/>RN/Electron
    participant WS as Spring Boot<br/>WebSocket+RTC
    participant KMS as Kurento<br/>Server
    participant B as ç”¨æˆ·B<br/>RN/Electron

    A->>WS: 1. WebSocket å·²è¿æ¥<br/>ç°æœ‰IMè¿æ¥

    A->>WS: 2. å‘é€RTCä¿¡ä»¤<br/>{type:'rtc',<br/>action:'call',<br/>targetUser:'user_b'}

    WS->>WS: 3. éªŒè¯èº«ä»½<br/>æ£€æŸ¥WebSocketä¼šè¯

    WS->>WS: 4. åˆ›å»ºæˆ¿é—´<br/>roomId=123,type=1v1

    WS->>KMS: 5. åˆ›å»º MediaPipeline<br/>åˆ›å»º Endpoint_A

    KMS-->>WS: Pipeline & Endpoint ID

    WS->>WS: 6. ä¿å­˜Session<br/>Redis: rtc:session:A

    WS->>WS: 7. è½¬å‘é€šè¯é‚€è¯·<br/>é€šè¿‡IMé€šçŸ¥ç”¨æˆ·B

    WS-->>B: 8. æ¨é€æ¥ç”µé€šçŸ¥<br/>(é€šè¿‡IMç³»ç»Ÿ)

    B->>B: 9. ç”¨æˆ·æ¥å¬

    B->>WS: 10. å‘é€RTCä¿¡ä»¤<br/>{type:'rtc',<br/>action:'answer',<br/>roomId:'123'}

    WS->>WS: 11. æ·»åŠ Båˆ°æˆ¿é—´

    WS->>KMS: 12. åˆ›å»º Endpoint_B

    WS->>KMS: 13. è¿æ¥ä¸¤ä¸ªEndpoint<br/>Endpoint_A â†” Endpoint_B

    WS->>Redis: 14. æ›´æ–°æˆ¿é—´æˆå‘˜åˆ—è¡¨

    A->>WS: 15. å‘é€SDP offer<br/>{type:'rtc',<br/>action:'offer',<br/>sdp:'...'}

    WS->>KMS: 16. processOffer<br/>ç»™ Endpoint_A

    KMS-->>WS: è¿”å› SDP answer

    WS-->>A: 17. è¿”å› answer

    A->>A: 18. setRemoteDescription

    A->>WS: 19. å‘é€ ICE candidate<br/>{type:'rtc',<br/>action:'candidate',<br/>candidate:'...'}

    WS->>KMS: 20. addIceCandidate<br/>ç»™ Endpoint_A

    B->>WS: 21. å‘é€ SDP offer

    WS->>KMS: 22. processOffer<br/>ç»™ Endpoint_B

    KMS-->>WS: è¿”å› SDP answer

    WS-->>B: 23. è¿”å› answer

    B->>WS: 24. å‘é€ ICE candidates

    WS->>KMS: 25. è½¬å‘ ICE

    Note over A,B: 26. åª’ä½“è¿æ¥å»ºç«‹<br/>éŸ³è§†é¢‘æµå¼€å§‹

    A<-->KMS: éŸ³è§†é¢‘æ•°æ®
    KMS<-->B: éŸ³è§†é¢‘æ•°æ®

    A->>WS: 27. æŒ‚æ–­<br/>{type:'rtc',<br/>action:'leave'}

    WS->>KMS: 28. é‡Šæ”¾ Endpoint_A

    WS->>Redis: 29. æ›´æ–°æˆ¿é—´çŠ¶æ€

    WS->>B: 30. é€šçŸ¥Bæ–­å¼€è¿æ¥

    B->>WS: 31. leaveç¡®è®¤

    WS->>KMS: 32. é‡Šæ”¾ Endpoint_B

    WS->>KMS: 33. é”€æ¯ Pipeline

    WS->>MySQL: 34. è®°å½•é€šè¯å†å²
```

---

## âš¡ **æ€§èƒ½å’Œå¯é æ€§è®¾è®¡**

### **WebSocket ä¼šè¯ç®¡ç†**

```mermaid
graph TB
    subgraph Lifecycle["ä¼šè¯ç”Ÿå‘½å‘¨æœŸ"]
        Connect["è¿æ¥å»ºç«‹<br/>â†’ åˆ›å»ºSession"]
        Active["ä¼šè¯æ´»è·ƒ<br/>â†’ å¿ƒè·³/æ¶ˆæ¯"]
        Inactive["ä¸æ´»è·ƒ<br/>â†’ è¶…æ—¶æ£€æµ‹"]
        Reconnect["æ–­çº¿é‡è¿<br/>â†’ æ¢å¤çŠ¶æ€"]
        Disconnect["æ–­å¼€è¿æ¥<br/>â†’ æ¸…ç†èµ„æº"]
    end
    
    subgraph Handling["äº‹ä»¶å¤„ç†"]
        Heartbeat["å¿ƒè·³æ£€æµ‹<br/>æ¯30ç§’ä¸€æ¬¡"]
        Timeout["è¶…æ—¶å¤„ç†<br/>> 90ç§’æ— æ¶ˆæ¯"]
        Restore["çŠ¶æ€æ¢å¤<br/>é‡è¿æ—¶åŒæ­¥RTCçŠ¶æ€"]
        Cleanup["èµ„æºæ¸…ç†<br/>é‡Šæ”¾Endpoint"]
    end
    
    Connect --> Active
    Active --> Heartbeat
    Heartbeat --> Active
    
    Active --> Inactive
    Inactive --> Timeout
    Timeout --> Disconnect
    
    Active --> Disconnect
    Disconnect --> Cleanup
    
    Disconnect -.->|æ–­çº¿åé‡è¿| Reconnect
    Reconnect --> Restore
    Restore --> Active
    
    style Heartbeat fill:#4caf50
    style Restore fill:#2196f3
    style Cleanup fill:#f44336
```

---

## ğŸ“‹ **å®æ–½æ­¥éª¤**

```mermaid
graph LR
    Phase1["ğŸ”µ ç¬¬ä¸€é˜¶æ®µ<br/>æ”¹é€ WebSocket<br/>æ·»åŠ RTCæ¶ˆæ¯è·¯ç”±<br/>2å‘¨"]
    
    Phase2["ğŸ”µ ç¬¬äºŒé˜¶æ®µ<br/>å¼€å‘RTCä¿¡ä»¤æ¨¡å—<br/>é›†æˆKMS<br/>4å‘¨"]
    
    Phase3["ğŸ”µ ç¬¬ä¸‰é˜¶æ®µ<br/>å‰ç«¯é›†æˆ<br/>RN+Electron<br/>3å‘¨"]
    
    Phase4["ğŸ”µ ç¬¬å››é˜¶æ®µ<br/>åŠŸèƒ½æ‰©å±•<br/>MCU/Broadcast/å½•åˆ¶<br/>4å‘¨"]
    
    Phase5["ğŸ”µ ç¬¬äº”é˜¶æ®µ<br/>æµ‹è¯•&ä¼˜åŒ–<br/>2å‘¨"]
    
    Phase1 --> Phase2
    Phase2 --> Phase3
    Phase3 --> Phase4
    Phase4 --> Phase5
```

---

## âœ… **å…³é”®ä¼˜åŠ¿æ€»ç»“**

| ä¼˜åŠ¿  | è¯´æ˜  |
| --- | --- |
| **æ— éœ€æ–°å¢ WebSocket** | å¤ç”¨ç°æœ‰è¿æ¥ï¼Œé™ä½å¤æ‚åº¦ |
| **æ¶ˆæ¯è·¯ç”±ç®€å•** | åŸºäº type å­—æ®µåˆ†å‘ï¼Œæ˜“äºç»´æŠ¤ |
| **ä¼šè¯ç»Ÿä¸€ç®¡ç†** | ç”¨æˆ·èº«ä»½ã€åœ¨çº¿çŠ¶æ€å…±ç”¨ |
| **é›†æˆæˆæœ¬ä½** | ä¸ç°æœ‰ IM ç³»ç»Ÿç´§å¯†ç»“åˆ |
| **å¯è§‚æµ‹æ€§å¼º** | æ‰€æœ‰æ¶ˆæ¯æµåœ¨ WebSocket ä¸Šï¼Œä¾¿äºç›‘æ§ |
| **æ‰©å±•å®¹æ˜“** | æ–°å¢åŠŸèƒ½åªéœ€æ‰©å±•æ¶ˆæ¯ç±»å‹ |

-----------

æ³¨æ„ä¸æ˜¯è®©ä½ ç›´æ¥ç»™æˆ‘ç¼–å†™ä»£ç ï¼Œè€Œæ˜¯ç»™æˆ‘ä¸€ä¸ªéå¸¸åˆç†çš„æ€»çº²ï¼ŒåŸºäºè¿™ä¸ªä¼šè°ƒç”¨å¤šä¸ªaiè¿›è¡Œä»£ç ç¼–å†™æµ‹è¯•

æ³¨æ„ï¼šè®¾è®¡æ¶æ„å›¾ã€æµç¨‹å›¾ã€æ¨¡å—è°ƒç”¨å›¾ï¼Œè¯·ä½¿ç”¨mermaidæ¥ç”»
