- æ·±åº¦ä»£ç å®¡è®¡ä¸æ¶æ„è¿­ä»£æŠ¥å‘Š (Phoenix RTC)

## 1. æŠ¥å‘ŠèƒŒæ™¯
æœ¬æŠ¥å‘Šæ—¨åœ¨åˆå¹¶ã€Šç¤¾äº¤è½¯ä»¶éŸ³è§†é¢‘æ¶æ„è®¾è®¡ã€‹ä¸åˆæ¬¡ã€Šä»£ç å®¡æŸ¥ä¸æ¶æ„ä¼˜åŒ–æŠ¥å‘Šã€‹ï¼Œå¹¶åŸºäºå¯¹ `phoenix-rtc` ç°æœ‰ä»£ç åº“çš„**é€è¡Œæ·±åº¦å®¡è®¡**ï¼Œæä¾›æœ€ç»ˆçš„æ¶æ„ä¿®æ­£ä¸ä¿®å¤æ¸…å•ã€‚

**æ ¸å¿ƒç»“è®º**ï¼šå½“å‰é¡¹ç›®å·²å…·å¤‡â€œæ¼”ç¤ºçº§â€å®Œå¤‡æ€§ï¼Œä½†å­˜åœ¨ **3å¤„é«˜å±å®‰å…¨æ¼æ´**ã€**2å¤„æ ¸å¿ƒé€»è¾‘ç¼ºé™·** ä»¥åŠ **æ¶æ„å±‚é¢çš„ä¿¡ä»¤å†—ä½™**ã€‚å¦‚ä¸ä¿®å¤ï¼Œæ— æ³•ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

## 2. æ¶æ„ç°çŠ¶ä¸åç¦»åˆ†æ

| ç»´åº¦ | è®¾è®¡è“å›¾ | ç°çŠ¶ä»£ç  | é£é™©è¯„ä¼° |
| :--- | :--- | :--- | :--- |
| **ä¿¡ä»¤æ¶æ„** | å¤ç”¨ç°æœ‰ IM WebSocket é€šé“ | ç‹¬ç«‹æ­å»ºäº† Spring STOMP WebSocket (`/ws/rtc`) | ğŸŸ  **ä¸­ (æ¶æ„åç¦»)**: å¯¼è‡´å®¢æˆ·ç«¯ç»´æŠ¤åŒé•¿è¿æ¥ï¼Œå¢åŠ è€—ç”µä¸å¤æ‚åº¦ã€‚ |
| **åª’ä½“æ ¸å¿ƒ** | LiveKit (Go) | Java SDK (`LiveKitAdapter`) é›†æˆ | âœ… **ç¬¦åˆ**: é€‚é…å™¨æ¨¡å¼ (`MediaAdapter`) æŠ½è±¡è‰¯å¥½ã€‚ |
| **å‘¼å«æµç¨‹** | é‚€è¯· -> å“é“ƒ -> æ¥å¬ -> è¿æ¥åª’ä½“ | é‚€è¯· -> **ç«‹å³è¿æ¥åª’ä½“** -> ç­‰å¾…æ¥å¬ | ğŸ”´ **é«˜ (é€»è¾‘ç¼ºé™·)**: ä¸¥é‡æµªè´¹åª’ä½“æœåŠ¡å™¨èµ„æºï¼Œç”¨æˆ·ä½“éªŒé”™è¯¯ã€‚ |
| **é‰´æƒæœºåˆ¶** | JWT (RSA/HMAC) + åŠ¨æ€å¯†é’¥ | HMAC + **ç¡¬ç¼–ç é»˜è®¤å¯†é’¥** | ğŸ”´ **é«˜ (å®‰å…¨æ¼æ´)**: ç”Ÿäº§ç¯å¢ƒææ˜“è¢«ä¼ªé€  Tokenã€‚ |

---

## 3. é€è¡Œæ·±åº¦å®¡è®¡å‘ç° (æŒ‰ä¸¥é‡ç¨‹åº¦)

### ğŸ”´ 3.1 é«˜å±å®‰å…¨æ¼æ´ (Critical)

#### 1. ç¡¬ç¼–ç çš„ JWT å¯†é’¥
- **æ–‡ä»¶**: `server/.../config/JwtConfig.java` (ç¬¬ 21 è¡Œ)
- **ä»£ç **: `private String secretKey = "phoenix-rtc-secret-key-..."`
- **é—®é¢˜**: å¯†é’¥ç›´æ¥å†™åœ¨æºç ä¸­ã€‚ä¸€æ—¦ä»£ç æ³„æ¼ï¼Œæ‰€æœ‰ç”¨æˆ· Token å¯è¢«éšæ„ä¼ªé€ ã€‚
- **ä¿®å¤**: å¿…é¡»å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡ (`System.getenv`) è·å–ï¼Œè‹¥ä¸ºç©ºåˆ™å¯åŠ¨å¤±è´¥ã€‚

#### 2. æ¨¡æ‹Ÿè®¤è¯åé—¨
- **æ–‡ä»¶**: `server/.../controller/AuthController.java` (ç¬¬ 54 è¡Œ)
- **ä»£ç **: `if (!"password123".equals(password))`
- **é—®é¢˜**: ä½¿ç”¨äº†é€šç”¨ç¡¬ç¼–ç å¯†ç ã€‚
- **ä¿®å¤**: éœ€é›†æˆçœŸå®çš„ `UserService` æˆ–æ¥å…¥ç°æœ‰è´¦æˆ·ç³»ç»Ÿçš„æ•°æ®åº“æ ¡éªŒã€‚

#### 3. LiveKit API å¯†é’¥ç¡¬ç¼–ç 
- **æ–‡ä»¶**: `server/.../adapter/LiveKitAdapter.java` (ç¬¬ 26-30 è¡Œ)
- **ä»£ç **: `@Value("${livekit.api.key:devkey}")`
- **é—®é¢˜**: é»˜è®¤å€¼ `devkey` æ˜¯ LiveKit å¼€å‘æ¨¡å¼çš„é»˜è®¤å€¼ï¼Œç”Ÿäº§ç¯å¢ƒè‹¥æœªé…ç½® Env ä¼šå¯¼è‡´ä½¿ç”¨é»˜è®¤å¯†é’¥ï¼Œææ˜“è¢«æ”»å‡»ã€‚

### ğŸŸ  3.2 æ ¸å¿ƒé€»è¾‘ç¼ºé™· (Major)

#### 4. äº‹åŠ¡èŒƒå›´è¿‡å¤§ (Distributed Transaction Issue)
- **æ–‡ä»¶**: `server/.../service/RoomService.java` (ç¬¬ 54-162 è¡Œ)
- **ä»£ç **: `startCall` æ–¹æ³•æ ‡è®°äº† `@Transactional`ã€‚
- **é—®é¢˜**: åœ¨æ•°æ®åº“äº‹åŠ¡å†…éƒ¨è°ƒç”¨äº† **å¤–éƒ¨ RPC** (`mediaAdapter.createRoom` -> LiveKit HTTP API)ã€‚
- **åæœ**: å¦‚æœ LiveKit å“åº”ç¼“æ…¢ï¼Œä¼šé•¿æ—¶é—´å ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œå¯¼è‡´æ•°æ®åº“ååé‡é›ªå´©ã€‚
- **ä¿®å¤**: å°† LiveKit è°ƒç”¨ç§»å‡º `@Transactional` èŒƒå›´ï¼Œæˆ–å…ˆæ‰§è¡Œ LiveKit æ“ä½œï¼ˆä¸å›æ»šï¼‰ï¼Œå†æ‰§è¡Œèƒ½å¤Ÿå›æ»šçš„æ•°æ®åº“æ“ä½œã€‚

#### 5. å®¢æˆ·ç«¯â€œæŠ¢è·‘â€è¿æ¥
- **æ–‡ä»¶**: `client-mobile/.../hooks/useCallSession.ts` (ç¬¬ 76 è¡Œ)
- **ä»£ç **: `await liveKit.connect(...)` åœ¨ `startCall` ä¸­ç«‹å³æ‰§è¡Œã€‚
- **é—®é¢˜**: ç”¨æˆ·ç‚¹å‡»å‘¼å«å³å»ºç«‹ WebRTC è¿æ¥ï¼Œè€Œéç­‰å¾…å¯¹æ–¹æ¥å¬ã€‚æ­¤é€»è¾‘å®Œå…¨è¿èƒŒæ ‡å‡† VoIP æµç¨‹ã€‚
- **ä¿®å¤**: `startCall` ä»…å‘é€ä¿¡ä»¤ï¼Œ`liveKit.connect` å¿…é¡»åœ¨æ”¶åˆ° `accept` äº‹ä»¶åè§¦å‘ã€‚

#### 6. æ­»ä»£ç ä¸å‚æ•°é”™è¯¯
- **æ–‡ä»¶**: `server/.../controller/WebSocketController.java` (ç¬¬ 91 è¡Œ)
- **ä»£ç **: `webSocketService.sendInvite(...)` å°‘ä¼ ä¸€ä¸ªå‚æ•° `title`ã€‚
- **é—®é¢˜**: ç¼–è¯‘æ— æ³•é€šè¿‡ã€‚ä¸” `handleInvite` é€»è¾‘ä¸ REST API `RtcController` é‡å¤ï¼Œå±äºåºŸå¼ƒé€»è¾‘æœªæ¸…ç†ã€‚

### ğŸŸ¡ 3.3 ä»£ç è´¨é‡ä¸è§„èŒƒ (Minor)

#### 7. å¼‚å¸¸å¤„ç†ç²—ç³™
- **æ–‡ä»¶**: `RoomService.java` (ç¬¬ 88 è¡Œ)
- **ä»£ç **: ç›´æ¥ä½¿ç”¨ `LocalDateTime.now()`ã€‚
- **å»ºè®®**: åº”ç»Ÿä¸€ä½¿ç”¨ `Clock` æˆ– UTC æ—¶é—´æˆ³ï¼Œé¿å…æ—¶åŒºé—®é¢˜ã€‚

#### 8. ç¼ºä¹é‡è¯•æœºåˆ¶
- **æ–‡ä»¶**: `LiveKitAdapter.java`
- **ä»£ç **: HTTPè¯·æ±‚å¤±è´¥ç›´æ¥æŠ›å‡º RuntimeExceptionã€‚
- **å»ºè®®**: å¢åŠ  Retry æœºåˆ¶ï¼ˆå¦‚ Resilience4jï¼‰ï¼Œå¤„ç†çŸ­æš‚çš„ç½‘ç»œæ³¢åŠ¨ã€‚

---

## 4. æ¶æ„æ•´åˆæ–¹æ¡ˆ (The Final Plan)

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜å¹¶åˆå¹¶è®¾è®¡æ–‡æ¡£ï¼Œæå‡ºä»¥ä¸‹æœ€ç»ˆå®æ–½æ–¹æ¡ˆï¼š

### 4.1 ç»Ÿä¸€ä¿¡ä»¤é€šé“ (Unified Signaling)
*   **åºŸå¼ƒ**: `WebSocketController.java` åŠ Server ç«¯ç‹¬ç«‹çš„ WebSocket æœåŠ¡ã€‚
*   **é‡‡ç”¨**: å®šä¹‰æ ‡å‡† `SignalingInterface`ã€‚
    *   **å®ç° A (Dev)**: ç®€å•çš„ Polling æˆ– ä¸´æ—¶ Socketã€‚
    *   **å®ç° B (Prod)**: é€‚é…ç°æœ‰ IM ç³»ç»Ÿçš„ HTTP æ¨é€æ¥å£ / æ¶ˆæ¯é˜Ÿåˆ—ã€‚
*   **ç›¸å…³ä¿®æ”¹**: `RtcController` ä¸å†æ³¨å…¥ `WebSocketService`ï¼Œè€Œæ˜¯æ³¨å…¥ `SignalingService`ã€‚

### 4.2 ä¿®æ­£åçš„æ—¶åºå›¾ (Corrected Sequence)

```mermaid
sequenceDiagram
    participant A as å‘èµ·æ–¹(App)
    participant S as ä¸šåŠ¡æœåŠ¡(Spring)
    participant IM as IMé€šé“
    participant B as æ¥æ”¶æ–¹(App)
    participant LK as LiveKit SFU

    Note over A: ç”¨æˆ·ç‚¹å‡»æ‹¨æ‰“
    A->>S: POST /api/rtc/call/start
    S->>S: ç”Ÿæˆ roomId (ä¸ç”Ÿæˆ Token)
    S->>S: ä¿å­˜ CallSession (Status=Wait)
    S-->>A: è¿”å› roomId
    S->>IM: æ¨é€ Invite æ¶ˆæ¯ -> B
    
    Note over A: UIæ˜¾ç¤º"å‘¼å«ä¸­..." (æœªè¿æ¥åª’ä½“)
    
    B->>IM: æ”¶åˆ° Invite
    Note over B: UIå¼¹çª—å“é“ƒ
    B->>B: ç‚¹å‡»æ¥å¬
    
    B->>S: POST /api/rtc/call/join
    S->>LK: Create Room (API)
    S->>LK: Generate Token B
    S-->>B: è¿”å› Token B, LiveKit URL
    
    B->>LK: Connect() [å»ºç«‹åª’ä½“è¿æ¥]
    B->>S: POST /api/rtc/call/accept (æˆ–é€šè¿‡WS)
    S->>IM: æ¨é€ Accept æ¶ˆæ¯ -> A
    
    A->>S: è¯·æ±‚ Token A (ä¹‹å‰æœªè·å–)
    S->>LK: Generate Token A
    S-->>A: è¿”å› Token A
    A->>LK: Connect() [å»ºç«‹åª’ä½“è¿æ¥]
    
    Note over A,B: é€šè¯å»ºç«‹æˆåŠŸ
```

## 5. ç«‹å³æ‰§è¡Œçš„ä¿®å¤æ¸…å• (Action Items)

1.  **Delete**: åˆ é™¤ `WebSocketController.java` ä¸­çš„ `@MessageMapping` æ–¹æ³•ï¼Œæ¸…ç†æ­»ä»£ç ã€‚
2.  **Refactor**: é‡æ„ `RoomService.java`ï¼Œå°† `mediaAdapter.createRoom` ç§»å‡º `@Transactional` ä»£ç å—ã€‚
3.  **Security**: ä¿®æ”¹ `JwtConfig.java` å’Œ `LiveKitAdapter.java`ï¼Œç§»é™¤ç¡¬ç¼–ç ï¼Œæ”¹ä¸ºä» `@Value("${ENV_VAR}")` è¯»å–ï¼Œå¹¶æ·»åŠ å¯åŠ¨è‡ªæ£€ï¼ˆè‹¥æ— å€¼åˆ™æŠ¥é”™ï¼‰ã€‚
4.  **Client**: ä¿®æ”¹ `useCallSession.ts`ï¼Œæ‹†åˆ† `startCall` ä¸º "Send Invite" å’Œ "Connect Media" ä¸¤ä¸ªé˜¶æ®µã€‚

æ­¤æŠ¥å‘Šå·²ä½œä¸ºé¡¹ç›®ä»£ç æ•´æ”¹çš„æœ€ç»ˆè“å›¾ã€‚


å‚è€ƒ@æ·±åº¦ä»£ç å®¡è®¡ä¸æ¶æ„è¿­ä»£æŠ¥å‘Š.md å¯¹ä»£ç è¿›è¡Œå†æ¬¡æ£€æŸ¥å’Œä¿®å¤